<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø§Ù„ÙˆÙ„ÙŠØ¯ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</title>
<!-- PWA Tags -->
<meta name="theme-color" content="#2c3e50">
<link rel="manifest" href=""> <!-- Href will be set by JavaScript -->
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2YwZjRmNyIvPjxwYXRoIGQ9Ik0yNSw3NSBMMjAsODAgTDIwLDg1IEwyNSw4NSBMNzUsMzUgTDY1LDI1IFoiIGZpbGw9IiNEMzU0MDAiLz48cGF0aCBkPSJNNzAsMjAgTDgwLDMwIEw0MCw3MCBMMzAsNjAgWiIgZmlsbD0iIzJDM0U1MCIvPjxyZWN0IHg9IjI1IiB5PSI4MCIgd2lkdGg9IjUiIGhlaWdodD0iNSIgZmlsbD0iIzJDM0U1MCIvPjwvc3ZnPg==">


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;600;800&family=Lalezar&family=Noto+Naskh+Arabic:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root {
  /* Light Theme (Default) */
  --primary: #2c3e50; --accent: #d35400; --bg: #f0f4f7; --card: #ffffff;
  --text-primary: #212529; --text-muted: #7f8c8d; --border-color: #dce4ec;
  --border-color-strong: #34495e; --page-shadow: 0 10px 40px rgba(44, 62, 80, 0.2);
  --toolbar-bg: #ffffff; --input-bg: #ffffff; --hover-bg: #f1f5f9;
  --table-header-bg: #f3f3f3; --warning-bg: #fcf8e3; --warning-text: #8a6d3b;
  --font-main: "Cairo", sans-serif; --font-formal: "Amiri", serif; --toolbar-height: 55px;
}
html[data-theme="dark"] {
  --primary: #526f8c; --accent: #e67e22; --bg: #1a202c; --card: #2d3748;
  --text-primary: #edf2f7; --text-muted: #a0aec0; --border-color: #4a5568;
  --border-color-strong: #9fb3c8; --page-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
  --toolbar-bg: #2d3748; --input-bg: #4a5568; --hover-bg: #4a5568;
  --table-header-bg: #374151; --warning-bg: #4a3f2d; --warning-text: #e6d3a0;
}
*{box-sizing:border-box}
html,body{ height:100%; margin:0; font-family:var(--font-main); background:var(--bg); color:var(--text-primary); direction:rtl; transition: background-color 0.3s ease, color 0.3s ease; }
.app {display:flex; flex-direction:column; height:100vh; overflow:hidden;}
.topbar, .login-box, .card, .toolbar, .editor-footer, .modal-box, .page { transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; }
.topbar {display:flex; justify-content:space-between; align-items:center; padding:10px 15px; background:var(--card); border-bottom:1px solid var(--border-color); box-shadow: 0 2px 10px rgba(0,0,0,0.05);}
.brand {font-weight:800; color:var(--primary); font-size:18px}
.top-actions {display:flex; gap:8px; align-items:center}
#theme-toggle-btn { font-size: 1.2rem; padding: 6px 10px; }
.screen {display:none; height:100%; overflow:hidden}
.screen.active {display:block}
.screen-with-topbar { height:calc(100% - 52px); }
.login-wrap {display:flex; align-items:center; justify-content:center; height:100%}
.login-box {background:var(--card); padding:28px; width:95%; max-width:420px; border-radius:12px; box-shadow: var(--page-shadow)}
.login-box h2 {margin-bottom:14px; color:var(--primary)}
.login-box input {width:100%; padding:10px 12px; margin-bottom:10px; border-radius:8px; border:1px solid var(--border-color); font-size:15px; background-color: var(--input-bg); color: var(--text-primary);}
.main-shell {padding:14px; height:100%; overflow:auto}
.grid {display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px}
.card {background:var(--card); padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); display:flex; flex-direction:column; gap:8px}
.editor-shell {display:flex; flex-direction:column; height:100%; position: relative;}
.toolbar { display: flex; flex-wrap: nowrap; gap: 10px; align-items: center; padding: 8px 12px; background: var(--toolbar-bg); border-bottom: 2px solid var(--border-color); overflow-x: auto; white-space: nowrap; position: sticky; top: 0; z-index: 1000; height: var(--toolbar-height); scrollbar-width: thin; scrollbar-color: var(--primary) #e0e6ef; }
#contextual-toolbar { top: var(--toolbar-height); z-index: 999; border-top: 1px solid var(--border-color); box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
.toolbar::-webkit-scrollbar { height: 8px; }
.toolbar::-webkit-scrollbar-track { background: #e0e6ef; border-radius: 4px;}
.toolbar::-webkit-scrollbar-thumb { background-color: var(--primary); border-radius: 4px; }
.controls-row { display: inline-flex; gap: 6px; align-items: center; padding-inline-end: 15px; border-inline-end: 1px solid var(--border-color); margin-inline-end: 10px; }
.controls-row:last-child { border-inline-end: none; }
.btn { background: var(--card); border:1px solid var(--border-color); padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600; color:var(--primary); transition: all 0.2s ease; font-size: 15px; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
.toolbar .btn { font-size: 16px; height: 40px; }
.btn:hover{background: var(--hover-bg); box-shadow:0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px);}
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
.btn svg { width: 18px; height: 18px; vertical-align: middle; }
.select {padding:8px 12px; border-radius:8px; border:1px solid var(--border-color); background:var(--input-bg); color: var(--text-primary); height: 40px;}
.color-input {width:40px; height:40px; padding:2px; border-radius:8px; border:1px solid var(--border-color); overflow:hidden; display:inline-block; background-color: var(--input-bg);}
.color-input input{width:100%; height:100%; border:0; padding:0; background:transparent}
.workspace { flex:1; overflow:auto; padding:20px; }
.editor-footer { display: flex; justify-content: space-between; align-items: center; padding: 5px 15px; background: var(--card); border-top: 1px solid var(--border-color); }
#overflow-warning { display: none; color: var(--warning-text); background-color: var(--warning-bg); padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
.zoom-controls, .pagination-controls { display: flex; align-items: center; gap: 10px; }
.zoom-controls input[type="range"] { width: 120px; }
.zoom-controls label { font-size: 14px; font-weight: 600; min-width: 45px; text-align: left; }
#page-indicator { font-weight: 600; font-size: 14px; min-width: 50px; text-align: center; }
.page { 
    background: var(--card); width: 21cm; min-height: 29.7cm; 
    position: relative; display: flex; flex-direction: column; 
    font-family: var(--font-formal); font-size: 28px;
    page-break-after: always; transform-origin: top center; 
    box-shadow: var(--page-shadow); 
    padding: 1cm;
    border: 2px solid var(--border-color-strong); 
    transition: transform 0.2s ease, margin-bottom 0.2s ease, background-color 0.3s ease, border-color 0.3s ease, border-style 0.3s ease, border-width 0.3s ease; 
    margin: 0 auto;
}
.page:not(:last-child) { margin-bottom: 20px; }
html[data-theme="dark"] .page { color: #333; }
.page.border-double { border: 8px double var(--border-color-strong); }
.page.border-dotted { border: 3px dotted var(--border-color-strong); }
.page.border-none { border: none; padding: calc(1cm + 2px); }
.page.border-dashed-thick { border: 4px dashed var(--border-color-strong); }
.page.border-double-color { border: 8px double var(--accent); }
.page.border-gradient { border: 8px solid transparent; border-image: linear-gradient(45deg, var(--primary), var(--accent)) 1; }
.continuation-header { padding: 8px; background-color: #f0f4f7; border-bottom: 1.5px solid #dce4ec; margin-bottom: 10px; text-align: center; font-size: 0.9em; }
.page .page-delete-btn { position: absolute; width: 24px; height: 24px; background: #e74c3c; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 16px; line-height: 24px; }
.page:hover .page-delete-btn { display: flex; top: -12px; left: -12px; }
.questions-table tr .row-actions { position: absolute; display: none; flex-direction: column; gap: 4px; top: 50%; left: -34px; transform: translateY(-50%); z-index: 10; }
.questions-table tr:hover .row-actions { display: flex; }
.row-actions button { width: 28px; height: 28px; background: #7f8c8d; color: white; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 16px; line-height: 24px; }
.row-actions .row-delete-btn { background: #e74c3c; }
.row-actions .row-save-template-btn { background: #2980b9; font-size: 14px; }
.exam-header-container { padding-bottom: 10px; border-bottom: 2px solid var(--border-color-strong); margin-bottom: 15px; }
.exam-header-top-row { display: flex; justify-content: space-between; align-items: stretch; gap: 10px; }
.header-box, .header-box-center { border: 1px solid var(--border-color-strong); border-radius: 4px; padding: 5px; }
.header-box { flex: 1 1 35%; text-align: center; line-height: 1.5; font-size: 0.8em; }
.header-box-center { flex: 1 1 25%; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; gap: 5px; }
.exam-title-main { text-align: center; font-weight: bold; font-size: 1.2em; padding: 2px; width: 100%; }
.logo-container { cursor: pointer; display: flex; align-items: center; justify-content: center; width: 100%; height: 80px; }
.logo-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
.logo-placeholder { width: 100%; height: 100%; background: #f0f2f5; border: 2px dashed #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #888; flex-direction: column; }
.exam-footer { border-top: 2px solid var(--border-color-strong); padding-top: 10px; margin-top: auto; text-align: center; font-weight: bold; font-size: 1em; }
.questions-table { width: 100%; border-collapse: collapse; position: relative; font-size: 1em; } /* Inherits from .page */
.questions-table th, .questions-table td { border: 1px solid var(--border-color-strong); padding: 10px; vertical-align: top; position: relative; line-height: 1.6; }
.questions-table th { font-weight: 700; background: var(--table-header-bg); }
.col-num { width: 6%; } .col-grade { width: 8%; }
.page-content-wrapper { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
.inserted-item {
    display: inline-block;
    border: 1px dashed #ccc;
    position: relative;
    user-select: none;
    touch-action: none;
    cursor: default;
    vertical-align: middle;
}
.inserted-item img, .inserted-item svg, .inserted-item table { width: 100%; height: 100%; display: block; pointer-events: none;}
html[data-theme="dark"] .inserted-item svg { filter: invert(1); }
.inserted-item table { border-collapse: collapse; }
.inserted-item table td { border: 1px solid black; padding: 5px; pointer-events: auto;}
.math-template { display: inline-block; vertical-align: middle; margin: 0 2px; }
.inserted-item.selected { outline: 2px dashed var(--accent); box-shadow: 0 0 0 4px rgba(211, 84, 0, 0.2); z-index: 100; }
.item-controls { position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none; }
.item-controls > * { pointer-events: auto; }
.resize-handle { position: absolute; width: 16px; height: 16px; background: var(--accent); border: 2px solid var(--card); border-radius: 50%; bottom: -8px; right: -8px; cursor: se-resize; }
.rotate-handle { position: absolute; width: 16px; height: 16px; background: var(--primary); border: 2px solid var(--card); border-radius: 50%; top: -8px; right: -8px; cursor: grab; }
.rotate-handle:active { cursor: grabbing; }
.delete-handle { position: absolute; width: 16px; height: 16px; background: #e74c3c; color: white; border: 2px solid var(--card); border-radius: 50%; top: -8px; left: -8px; cursor: pointer; font-size: 12px; line-height: 12px; text-align: center; font-weight: bold; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
.modal-box { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: var(--page-shadow); width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;}
.modal-box h3, .modal-box h4 { margin-top: 0; color: var(--primary); }
.modal-box .form-group { margin-bottom: 15px; }
.modal-box .form-group label { display: block; margin-bottom: 5px; }
.modal-box .form-group input, .modal-box .form-group select, .gemini-modal-content textarea { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--input-bg); color: var(--text-primary); }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
.border-options { display: flex; justify-content: space-around; gap: 10px; flex-wrap: wrap; }
.border-options .btn { flex-direction: column; height: auto; padding: 10px; }
.border-options .border-preview { width: 60px; height: 40px; border: 2px solid var(--text-primary); margin-bottom: 5px; }
.border-options .border-double { border-style: double; border-width: 4px; }
.border-options .border-dotted { border-style: dotted; }
.shape-grid, .math-grid, .symbol-grid, .template-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; }
.shape-item, .math-item, .symbol-item, .template-item { padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; display:flex; align-items:center; justify-content:center; flex-direction:column; text-align:center; }
.shape-item:hover, .math-item:hover, .symbol-item:hover, .template-item:hover { background: var(--hover-bg); border-color: var(--primary); }
.shape-item svg { width: 100%; height: 40px; }
.math-item { font-family: var(--font-formal); font-size: 1.1em; min-height: 60px; line-height: 1.2; }
.math-item small, .shape-item small { font-size: 0.7em; font-family: var(--font-main); color: var(--text-muted); margin-top: 5px; }
.symbol-item { font-size: 1.8em; }
.template-list { grid-template-columns: 1fr; }
.template-item { flex-direction: row; justify-content: space-between; align-items: center; }
.template-item .template-content { flex: 1; text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.template-item button { background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; }
.gemini-modal-content textarea { min-height: 150px; margin-top: 10px; font-size: 15px; resize: vertical; }
.loader { border: 4px solid var(--hover-bg); border-radius: 50%; border-top: 4px solid var(--primary); width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@media print { html, body, .app, .workspace { background: #fff !important; color: #000 !important; } .topbar, .toolbar, .editor-footer, .page-delete-btn, .row-actions, .item-controls, #add-page-overflow-btn { display: none !important; } .workspace { padding: 0; overflow-y: visible !important; } .page { transform: scale(1) !important; box-shadow: none !important; margin: 0 !important; border-color: #34495e !important; background-color: #fff !important; color: #000 !important; } .page.border-double { border: 8px double #34495e !important; } .page.border-dotted { border: 3px dotted #34495e !important; } .page.border-none { border: none !important; } .inserted-item.selected { outline: none; box-shadow: none; } .inserted-item { border-color: transparent; } .header-box, .exam-title-main { border: 1px solid #34495e !important; } .questions-table th, .questions-table td { border: 1px solid #34495e !important; } .questions-table th { background-color: #f3f3f3 !important; } }
.hidden{display:none}
</style>
</head>
<body>

<div class="app">
  <div class="topbar">
    <div class="brand">Ø§Ù„ÙˆÙ„ÙŠØ¯ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</div>
    <div class="top-actions">
      <button id="theme-toggle-btn" class="btn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¸Ù‡Ø±">ğŸŒ™</button>
      <span id="user-display" class="small"></span>
      <button id="logout-btn" class="btn small hidden">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div id="login-screen" class="screen screen-with-topbar active">
    <div class="login-wrap"><div class="login-box"><h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2><input id="teacher-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³/Ø©" /><input id="school-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" /><div style="display:flex; gap:8px; margin-top:6px"><button id="login-btn" class="btn" style="flex:1">Ø§Ù„Ø¯Ø®ÙˆÙ„</button></div></div></div>
  </div>

  <div id="main-screen" class="screen screen-with-topbar">
    <div class="main-shell"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px"><h3>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h3><div><button id="new-exam-btn" class="btn">Ø§Ø®ØªØ¨Ø§Ø± ÙØ§Ø±Øº</button></div></div><div id="exam-grid" class="grid"></div></div>
  </div>

  <div id="editor-screen" class="screen">
    <div class="editor-shell">
      <div class="toolbar">
        <div class="controls-row">
          <button class="btn" data-cmd="undo" title="ØªØ±Ø§Ø¬Ø¹">â†¶</button>
          <button class="btn" data-cmd="redo" title="Ø¥Ø¹Ø§Ø¯Ø©">â†·</button>
          <button class="btn" id="save-exam" title="Ø­ÙØ¸">ğŸ’¾</button>
          <button class="btn" id="print-btn" title="Ø·Ø¨Ø§Ø¹Ø©">ğŸ–¨ï¸</button>
          <button class="btn" id="export-pdf" title="ØªØµØ¯ÙŠØ± PDF">ğŸ“„</button>
          <button class="btn" id="back-to-main-btn" title="Ø§Ù„Ø±Ø¬ÙˆØ¹">Ø±Ø¬ÙˆØ¹</button>
        </div>
        <div class="controls-row">
            <button class="btn" id="add-question-btn" title="Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„">â• Ø³Ø¤Ø§Ù„</button>
            <button class="btn" id="delete-question-btn" title="Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            <button class="btn" id="add-page-btn" title="Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø©">â• ØµÙØ­Ø©</button>
            <button class="btn" id="shuffle-questions-btn" title="Ø®Ù„Ø· ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ø¹Ù…Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø¢Ø®Ø±">ğŸ”€</button>
            <button class="btn" id="insert-question-template-btn" title="Ø¥Ø¯Ø±Ø§Ø¬ Ù‚Ø§Ù„Ø¨ Ø³Ø¤Ø§Ù„">ğŸ“‹ Ù‚Ø§Ù„Ø¨</button>
            <button class="btn" id="save-selection-btn" title="Ø­ÙØ¸ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙƒÙ‚Ø§Ù„Ø¨" disabled>ğŸ’¾ Ù†Øµ</button>
        </div>
        <div class="controls-row">
            <button class="btn" id="insert-image" title="Ø¥Ø¯Ø±Ø§Ø¬ ØµÙˆØ±Ø©">ğŸ–¼ï¸</button>
            <button class="btn" id="insert-table" title="Ø¥Ø¯Ø±Ø§Ø¬ Ø¬Ø¯ÙˆÙ„">â–¦</button>
            <button class="btn" id="insert-shape" title="Ø¥Ø¯Ø±Ø§Ø¬ Ø´ÙƒÙ„">ğŸ¨</button>
            <button class="btn" id="insert-symbol-btn" title="Ø¥Ø¯Ø±Ø§Ø¬ Ø±Ù…Ø²">Î©</button>
            <button class="btn" id="rotate-item-btn" title="ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯" disabled>â†ªï¸</button>
            <button class="btn" id="change-border-btn" title="ØªØºÙŠÙŠØ± Ø¥Ø·Ø§Ø± Ø§Ù„ØµÙØ­Ø©">ğŸ–¼ï¸ Ø¥Ø·Ø§Ø±</button>
        </div>
        <div class="controls-row">
          <button class="btn" data-cmd="bold"><b>Ø¹</b></button>
          <button class="btn" data-cmd="italic"><i>Ù…</i></button>
          <button class="btn" data-cmd="underline"><u>Øª</u></button>
          <button class="btn" data-cmd="superscript" title="Ù†Øµ Ø¹Ù„ÙˆÙŠ">xÂ²</button>
          <button class="btn" data-cmd="subscript" title="Ù†Øµ Ø³ÙÙ„ÙŠ">xâ‚‚</button>
          <select id="font-name" class="select">
            <option style="font-family: 'Amiri';" value="Amiri">Amiri</option>
            <option style="font-family: 'Cairo';" value="Cairo">Cairo</option>
            <option style="font-family: 'Tajawal';" value="Tajawal">Tajawal</option>
            <option style="font-family: 'Lalezar';" value="Lalezar">Lalezar</option>
            <option style="font-family: 'Noto Naskh Arabic';" value="Noto Naskh Arabic">Noto Naskh</option>
            <option style="font-family: 'Arial';" value="Arial">Arial</option>
          </select>
          <button class="btn" id="decrease-size" title="ØªØµØºÙŠØ± Ø§Ù„Ù†Øµ">-</button>
          <button class="btn" id="increase-size" title="ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù†Øµ">+</button>
          <div class="color-input"><input id="font-color" type="color" title="Ù„ÙˆÙ† Ø§Ù„Ø®Ø·"></div>
        </div>
        <div class="controls-row">
            <button class="btn" data-cmd="justifyRight" title="Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠÙ…ÙŠÙ†">â˜µ</button>
            <button class="btn" data-cmd="justifyCenter" title="ØªÙˆØ³ÙŠØ·">â˜²</button>
            <button class="btn" data-cmd="justifyLeft" title="Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠØ³Ø§Ø±">â˜´</button>
            <button class="btn" id="decrease-line-height" title="ØªÙ‚Ù„ÙŠÙ„ ØªØ¨Ø§Ø¹Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±">â–¼</button>
            <button class="btn" id="increase-line-height" title="Ø²ÙŠØ§Ø¯Ø© ØªØ¨Ø§Ø¹Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±">â–²</button>
            <button class="btn" data-vertical-align="top" title="Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰">â¤’</button>
            <button class="btn" data-vertical-align="middle" title="Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙˆØ³Ø·">â‡¹</button>
            <button class="btn" data-vertical-align="bottom" title="Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„Ø£Ø³ÙÙ„">â¤“</button>
        </div>
         <div class="controls-row">
            <button class="btn" data-orientation="horizontal-tb" title="Ø§ØªØ¬Ø§Ù‡ Ø£ÙÙ‚ÙŠ">â†”</button>
            <button class="btn" data-orientation="vertical-rl" title="Ø¹Ù…ÙˆØ¯ÙŠ (Ù„Ù„ÙŠÙ…ÙŠÙ†)">â†“â†’</button>
            <button class="btn" data-orientation="vertical-lr" title="Ø¹Ù…ÙˆØ¯ÙŠ (Ù„Ù„ÙŠØ³Ø§Ø±)">â†“â†</button>
            <button class="btn" id="toggle-rotate-text" title="Ù‚Ù„Ø¨ Ø§Ù„Ù†Øµ Ø±Ø£Ø³Ù‹Ø§ Ø¹Ù„Ù‰ Ø¹Ù‚Ø¨">ğŸ”„</button>
        </div>
        <div class="controls-row">
          <button class="btn" id="insert-fraction" title="ÙƒØ³Ø±">Ã·</button>
          <button class="btn" id="insert-sqrt" title="Ø¬Ø°Ø± ØªØ±Ø¨ÙŠØ¹ÙŠ">âˆš</button>
          <button class="btn" id="insert-power" title="Ø£Ø³">xÊ¸</button>
          <button class="btn" id="insert-more-math" title="Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ø¹Ø§Ø¯Ù„Ø§Øª">âˆ«</button>
        </div>
      </div>
      <!-- New Contextual Toolbar -->
      <div id="contextual-toolbar" class="toolbar" style="display: none;"></div>
      <div id="workspace" class="workspace"></div>
      
      <div class="editor-footer">
        <span id="overflow-warning">ØªØ­Ø°ÙŠØ±: ØªØ¬Ø§ÙˆØ² ÙÙŠ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø©</span>
        <div class="zoom-controls">
            <label id="zoom-label">60%</label>
            <input type="range" id="zoom-slider" min="20" max="150" value="60">
        </div>
        <div class="pagination-controls">
            <button id="prev-page-btn" class="btn" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©">â—€</button>
            <span id="page-indicator">1 / 1</span>
            <button id="next-page-btn" class="btn" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©">â–¶</button>
        </div>
        <span id="save-status">Ø¬Ø§Ù‡Ø²</span>
      </div>
    </div>
  </div>
</div>
<input type="file" id="logo-input" accept="image/*" class="hidden">
<input type="file" id="image-input" accept="image/*" class="hidden">
<div id="modal-container" class="modal-overlay"></div>

<script>
// --- STATE & SETUP ---
let currentUser = null, currentExamId = null, focusedEditable = null, activeItem = null, savedSelection = null;
let historyDebounceTimer, autoSaveInterval;
let currentPageIndex = 0;
let pageObserver;

const workspace = document.getElementById('workspace');
const modalContainer = document.getElementById('modal-container');
const zoomSlider = document.getElementById('zoom-slider');
const zoomLabel = document.getElementById('zoom-label');
const themeToggleBtn = document.getElementById('theme-toggle-btn');
const overflowWarning = document.getElementById('overflow-warning');
const contextualToolbar = document.getElementById('contextual-toolbar');


document.addEventListener('DOMContentLoaded', initApp);

function initApp() {
    setupPWA();
    setupEventListeners();
    applyInitialTheme();
    setupPageObserver();
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        document.getElementById('user-display').textContent = `${currentUser.teacher} â€” ${currentUser.school}`;
        document.getElementById('logout-btn').classList.remove('hidden');
        showScreen('main-screen');
        renderExamGrid();
    } else {
        showScreen('login-screen');
    }
    updatePageZoom();
    updatePaginationUI();
}

function setupEventListeners() {
    themeToggleBtn.addEventListener('click', toggleTheme);
    document.getElementById('login-btn').addEventListener('click', handleLogin);
    document.getElementById('new-exam-btn').addEventListener('click', () => newExam());
    document.getElementById('logout-btn').addEventListener('click', logout);
    document.getElementById('back-to-main-btn').addEventListener('click', () => { showScreen('main-screen'); renderExamGrid(); });
    document.getElementById('save-exam').addEventListener('click', () => saveExam(true));
    document.getElementById('print-btn').addEventListener('click', () => window.print());
    document.getElementById('export-pdf').addEventListener('click', exportPDF);
    document.getElementById('add-question-btn').addEventListener('click', () => addQuestionToTable());
    document.getElementById('delete-question-btn').addEventListener('click', deleteCurrentQuestion);
    document.getElementById('add-page-btn').addEventListener('click', addContinuationPage);
    document.getElementById('shuffle-questions-btn').addEventListener('click', shuffleQuestions);
    document.getElementById('save-selection-btn').addEventListener('click', saveSelectionAsTemplate);
    document.getElementById('insert-image').addEventListener('click', () => document.getElementById('image-input').click());
    document.getElementById('insert-table').addEventListener('click', showTableModal);
    document.getElementById('insert-shape').addEventListener('click', showShapeModal);
    document.querySelectorAll('[data-cmd]').forEach(b => b.addEventListener('click', () => execCmd(b.dataset.cmd, b.dataset.value || null)));
    document.getElementById('font-name').addEventListener('change', (e) => { restoreSelection(); execCmd('fontName', e.target.value); });
    document.getElementById('font-color').addEventListener('input', (e) => { execCmd('foreColor', e.target.value); });
    document.getElementById('increase-size').addEventListener('click', () => changeSelectedFontSize(2));
    document.getElementById('decrease-size').addEventListener('click', () => changeSelectedFontSize(-2));
    document.getElementById('increase-line-height').addEventListener('click', () => changeLineHeight(0.1));
    document.getElementById('decrease-line-height').addEventListener('click', () => changeLineHeight(-0.1));
    document.querySelectorAll('[data-orientation]').forEach(b => b.addEventListener('click', () => setTextOrientation(b.dataset.orientation)));
    document.getElementById('toggle-rotate-text').addEventListener('click', toggleTextRotation);
    document.querySelectorAll('[data-vertical-align]').forEach(b => b.addEventListener('click', (e) => setVerticalAlign(e.currentTarget.dataset.verticalAlign)));
    document.getElementById('rotate-item-btn').addEventListener('click', rotateActiveItem);
    document.getElementById('insert-symbol-btn').addEventListener('click', showSymbolModal);
    document.getElementById('insert-question-template-btn').addEventListener('click', showQuestionTemplateModal);
    document.querySelectorAll('.toolbar .btn, .toolbar .select, .toolbar .color-input').forEach(el => {
        el.addEventListener('mousedown', e => { saveSelection(); if(el.tagName !== 'SELECT') e.preventDefault(); });
    });
    
    document.addEventListener('selectionchange', () => {
        const sel = window.getSelection();
        document.getElementById('save-selection-btn').disabled = sel.isCollapsed;
    });

    workspace.addEventListener('focusin', e => { 
        if (e.target.isContentEditable) focusedEditable = e.target;
    });
    workspace.addEventListener('click', handleWorkspaceClick);
    workspace.addEventListener('input', () => { clearTimeout(historyDebounceTimer); historyDebounceTimer = setTimeout(saveExam, 2000); });
    workspace.addEventListener('scroll', () => {
        let closestPage = 0; let minDistance = Infinity;
        const pages = workspace.querySelectorAll('.page');
        const containerMidpoint = workspace.getBoundingClientRect().top + workspace.clientHeight / 2;
        pages.forEach((page, index) => {
            const pageMidpoint = page.getBoundingClientRect().top + page.clientHeight / 2;
            const distance = Math.abs(containerMidpoint - pageMidpoint);
            if (distance < minDistance) { minDistance = distance; closestPage = index; }
        });
        if (closestPage !== currentPageIndex) { currentPageIndex = closestPage; updatePaginationUI(); }
    });
    document.getElementById('logo-input').addEventListener('change', e => handleImageUpload(e, '.logo-container img', true));
    document.getElementById('image-input').addEventListener('change', e => handleImageUpload(e, null, false));
    zoomSlider.addEventListener('input', updatePageZoom);
    document.getElementById('change-border-btn').addEventListener('click', showBorderModal);
    document.getElementById('insert-fraction').addEventListener('click', insertFraction);
    document.getElementById('insert-sqrt').addEventListener('click', insertSqrt);
    document.getElementById('insert-power').addEventListener('click', insertPowerTemplate);
    document.getElementById('insert-more-math').addEventListener('click', showMathEquationsModal);
    document.getElementById('prev-page-btn').addEventListener('click', () => goToPage(currentPageIndex - 1));
    document.getElementById('next-page-btn').addEventListener('click', () => goToPage(currentPageIndex + 1));
}

function setupPWA() {
    const manifest = {
      name: "Ø§Ù„ÙˆÙ„ÙŠØ¯ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª",
      short_name: "Ù…Ø­Ø±Ø± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª",
      start_url: ".",
      display: "standalone",
      background_color: "#f0f4f7",
      theme_color: "#2c3e50",
      description: "ØªØ·Ø¨ÙŠÙ‚ ÙˆÙŠØ¨ Ù„ØªØ­Ø±ÙŠØ± ÙˆØªØµÙ…ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©.",
      icons: [{
        src: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2YwZjRmNyIvPjxwYXRoIGQ9Ik0yNSw3NSBMMjAsODAgTDIwLDg1IEwyNSw4NSBMNzUsMzUgTDY1LDI1IFoiIGZpbGw9IiNEMzU0MDAiLz48cGF0aCBkPSJNNzAsMjAgTDgwLDMwIEw0MCw3MCBMMzAsNjAgWiIgZmlsbD0iIzJDM0U1MCIvPjxyZWN0IHg9IjI1IiB5PSI4MCIgd2lkdGg9IjUiIGhlaWdodD0iNSIgZmlsbD0iIzJDM0U1MCIvPjwvc3ZnPg==",
        sizes: "192x192", type: "image/svg+xml"
      },{
        src: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2YwZjRmNyIvPjxwYXRoIGQ9Ik0yNSw3NSBMMjAsODAgTDIwLDg1IEwyNSw4NSBMNzUsMzUgTDY1LDI1IFoiIGZpbGw9IiNEMzU0MDAiLz48cGF0aCBkPSJNNzAsMjAgTDgwLDMwIEw0MCw3MCBMMzAsNjAgWiIgZmlsbD0iIzJDM0U1MCIvPjxyZWN0IHg9IjI1IiB5PSI4MCIgd2lkdGg9IjUiIGhlaWdodD0iNSIgZmlsbD0iIzJDM0U1MCIvPjwvc3ZnPg==",
        sizes: "512x512", type: "image/svg+xml"
      }]
    };
    const manifestString = JSON.stringify(manifest);
    const manifestBlob = new Blob([manifestString], {type: 'application/json'});
    const manifestUrl = URL.createObjectURL(manifestBlob);
    document.querySelector('link[rel="manifest"]').setAttribute('href', manifestUrl);
    
    if ('serviceWorker' in navigator) {
        const swContent = `
            const CACHE_NAME = 'exam-editor-cache-v1';
            const urlsToCache = ['.', 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js', 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'];
            self.addEventListener('install', event => { event.waitUntil( caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)) ); });
            self.addEventListener('fetch', event => { event.respondWith( caches.match(event.request).then(response => response || fetch(event.request)) ); });
        `;
        const swBlob = new Blob([swContent], {type: 'application/javascript'});
        const swUrl = URL.createObjectURL(swBlob);
        
        window.addEventListener('load', () => {
            navigator.serviceWorker.register(swUrl)
                .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
                .catch(err => console.log('ServiceWorker registration failed: ', err));
        });
    }
}


function applyInitialTheme() { const savedTheme = localStorage.getItem('theme') || 'light'; document.documentElement.setAttribute('data-theme', savedTheme); themeToggleBtn.innerHTML = savedTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™'; themeToggleBtn.title = savedTheme === 'dark' ? 'Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„ÙØ§ØªØ­' : 'Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¯Ø§ÙƒÙ†'; }
function toggleTheme() { const currentTheme = document.documentElement.getAttribute('data-theme'); const newTheme = currentTheme === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', newTheme); localStorage.setItem('theme', newTheme); themeToggleBtn.innerHTML = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™'; themeToggleBtn.title = newTheme === 'dark' ? 'Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„ÙØ§ØªØ­' : 'Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¯Ø§ÙƒÙ†'; }
function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); const topbar = document.querySelector('.topbar'); if (id === 'editor-screen') { topbar.style.display = 'none'; } else { topbar.style.display = 'flex'; } if(id !== 'editor-screen' && autoSaveInterval) { clearInterval(autoSaveInterval); } }
function handleLogin() { const teacher = document.getElementById('teacher-name').value.trim(); const school = document.getElementById('school-name').value.trim(); if (!teacher || !school) { return; } currentUser = { teacher, school }; localStorage.setItem('currentUser', JSON.stringify(currentUser)); document.getElementById('user-display').textContent = `${teacher} â€” ${school}`; document.getElementById('logout-btn').classList.remove('hidden'); showScreen('main-screen'); renderExamGrid(); }
function logout() { localStorage.removeItem('currentUser'); currentUser = null; showScreen('login-screen'); document.getElementById('logout-btn').classList.add('hidden'); }
function renderExamGrid() { const grid = document.getElementById('exam-grid'); grid.innerHTML = ''; const keys = Object.keys(localStorage).filter(k => k.startsWith('exam_')); keys.forEach(k => { const ex = JSON.parse(localStorage.getItem(k)); const card = document.createElement('div'); card.className = 'card'; card.innerHTML = `<h3>${escapeHtml(ex.title || 'Ø¨Ù„Ø§ Ø¹Ù†ÙˆØ§Ù†')}</h3><div class="row small"><span>${new Date(ex.lastModified).toLocaleString()}</span></div><div style="margin-top:8px; display:flex; gap:8px"><button class="btn" onclick="openExam('${ex.id}')">ÙØªØ­</button><button class="btn" style="background: #e74c3c; color:white" onclick="deleteExam('${ex.id}')">Ø­Ø°Ù</button></div>`; grid.appendChild(card); }); }
function newExam(templateHTML = '') { currentExamId = 'exam_' + Date.now(); const content = templateHTML || createNewPageHTML(); const newExamData = { id: currentExamId, title: 'Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯', lastModified: new Date().toISOString(), content }; localStorage.setItem(currentExamId, JSON.stringify(newExamData)); openEditorWithContent(content); showScreen('editor-screen'); }
function openExam(id) { const ex = JSON.parse(localStorage.getItem(id)); if (!ex) return; currentExamId = id; openEditorWithContent(ex.content); showScreen('editor-screen'); }
function deleteExam(id) { showModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', '<p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</p>', (confirmed) => { if (confirmed) { localStorage.removeItem(id); renderExamGrid(); } }); }

function openEditorWithContent(html) {
    workspace.innerHTML = (!html || html.trim() === '') ? createNewPageHTML() : html;
    initializeRowActions(); // Add actions buttons to loaded content
    if(autoSaveInterval) clearInterval(autoSaveInterval);
    autoSaveInterval = setInterval(saveExam, 30000);
    setTimeout(() => { goToPage(0); checkAllPagesForOverflow(); }, 100);
}

function saveExam(isManual = false) {
    if (activeItem) deselectItem();
    if (!currentExamId) return;

    // Clone workspace to remove UI elements before saving
    const workspaceClone = workspace.cloneNode(true);
    workspaceClone.querySelectorAll('.row-actions, .item-controls').forEach(el => el.remove());
    workspaceClone.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
    const cleanContent = workspaceClone.innerHTML;

    const firstTitle = workspace.querySelector('.exam-title-main')?.textContent.trim() || 'Ø§Ø®ØªØ¨Ø§Ø±';
    const payload = { id: currentExamId, title: firstTitle, lastModified: new Date().toISOString(), content: cleanContent };
    localStorage.setItem(currentExamId, JSON.stringify(payload));
    document.getElementById('save-status').textContent = `ØªÙ… Ø§Ù„Ø­ÙØ¸ ${new Date().toLocaleTimeString()}`;
    if(isManual) showModal('ØªÙ… Ø§Ù„Ø­ÙØ¸', '<p>ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.</p>');
}


// --- PAGE & CONTENT CREATION ---
function createNewPageHTML() { return `<div class="page"><div class="page-delete-btn" title="Ø­Ø°Ù Ø§Ù„ØµÙØ­Ø©">&times;</div><header class="exam-header-container"><div class="exam-header-top-row"><div class="header-box" contenteditable="true">Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„ÙŠÙ…Ù†ÙŠØ©<br>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…<br>Ù…ÙƒØªØ¨ Ø§Ù„ØªØ±Ø¨ÙŠÙ‡ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ… Ù…/ØªØ¹Ø²<br>Ø§Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ… Ù…/Ø®Ø¯ÙŠØ±<br>Ù…Ø¯Ø±Ø³Ø© / .................</div><div class="header-box-center"><div class="logo-container"><div class="logo-placeholder"><span>Ø§Ù†Ù‚Ø± Ù„Ø¥Ø¶Ø§ÙØ©</span><span>Ø´Ø¹Ø§Ø±</span></div><img src="" alt="" style="display:none;"></div><div class="exam-title-main" contenteditable="true">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div></div><div class="header-box" contenteditable="true">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: .......................<br>Ø§Ù„ØµÙ: ............................<br>Ø§Ù„Ù…Ø§Ø¯Ø©: ............................<br>Ø§Ù„Ø´Ø¹Ø¨Ø©: ...........................<br>Ø§Ù„ØªØ§Ø±ÙŠØ®: ...../...../...........</div></div></header><div class="page-content-wrapper"><table class="questions-table"><thead><tr><th class="col-num" contenteditable="true">Øª</th><th class="col-question" contenteditable="true">Ø§Ù„Ø³Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ø¤Ø§Ù„</th><th class="col-grade" contenteditable="true">Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr></thead><tbody></tbody></table></div><footer class="exam-footer" contenteditable="true">Ù…Ø¹ ØªÙ…Ù†ÙŠØ§ØªÙ†Ø§ Ù„ÙƒÙ… Ø¨Ø§Ù„Ù†Ø¬Ø§Ø­ ÙˆØ§Ù„ØªÙˆÙÙŠÙ‚</footer></div>`; }
function createNewContinuationPageHTML() { const pageNumber = workspace.querySelectorAll('.page').length + 1; return `<div class="page"><div class="page-delete-btn" title="Ø­Ø°Ù Ø§Ù„ØµÙØ­Ø©">&times;</div><header class="continuation-header" contenteditable="true">ØªØ§Ø¨Ø¹ Ø§Ø®ØªØ¨Ø§Ø± ...</header><div class="page-content-wrapper"><table class="questions-table"><thead><tr><th class="col-num" contenteditable="true">Øª</th><th class="col-question" contenteditable="true">Ø§Ù„Ø³Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ø¤Ø§Ù„</th><th class="col-grade" contenteditable="true">Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr></thead><tbody></tbody></table></div><footer class="exam-footer" contenteditable="true">ØµÙØ­Ø© (${pageNumber})</footer></div>`; }
function addContinuationPage() { const newPageHTML = createNewContinuationPageHTML(); workspace.insertAdjacentHTML('beforeend', newPageHTML); updatePageZoom(); const newPageIndex = workspace.querySelectorAll('.page').length - 1; goToPage(newPageIndex); return workspace.querySelector('.page:last-of-type'); }

// --- OVERFLOW CHECK & QUESTION MANAGEMENT ---
function setupPageObserver() { pageObserver = new MutationObserver(() => checkAllPagesForOverflow()); pageObserver.observe(workspace, { childList: true, subtree: true, characterData: true, attributes: true }); }
function isPageOverflowing(page) {
    if (!page) return false;
    const footer = page.querySelector('.exam-footer');
    const lastRow = page.querySelector('.questions-table tbody tr:last-child');
    if (!footer || !lastRow) { return page.scrollHeight > page.clientHeight + 1; }
    const footerTop = footer.getBoundingClientRect().top;
    const lastRowBottom = lastRow.getBoundingClientRect().bottom;
    return lastRowBottom > footerTop - 20; // 20px safety margin
}
function checkAllPagesForOverflow() { let isAnyPageOverflowing = false; workspace.querySelectorAll('.page').forEach(page => { if (isPageOverflowing(page)) isAnyPageOverflowing = true; }); overflowWarning.style.display = isAnyPageOverflowing ? 'inline' : 'none'; }
function placeCursorAtEnd(el) { el.focus(); const range = document.createRange(); range.selectNodeContents(el); range.collapse(false); const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range); }
function addQuestionToTable(content = '', targetPage = null) { 
    let page = targetPage || workspace.querySelector('.page:last-of-type');
    if (!page) { page = addContinuationPage(); }
    
    if (isPageOverflowing(page)) {
        showModal('ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„ØµÙØ­Ø© Ù…Ù…ØªÙ„Ø¦Ø©', '<p>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©. ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø£ÙˆÙ„Ø§Ù‹.</p><p>Ø§Ø¶ØºØ· "Ù…ÙˆØ§ÙÙ‚" Ù„Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙÙŠÙ‡Ø§.</p>', (confirmed) => { 
            if (confirmed) { const newPage = addContinuationPage(); addQuestionToTable(content, newPage); }
        });
        return;
    }

    let tbody = page.querySelector('.questions-table tbody');
    if(!tbody) return;
    const tr = document.createElement('tr');
    const rowCount = workspace.querySelectorAll('.questions-table tbody tr').length + 1;
    tr.innerHTML = `<td contenteditable="true" style="text-align: center;">${rowCount}</td><td class="q-text" contenteditable="true">${content}</td><td contenteditable="true" style="text-align: center;"></td>`;
    appendRowActions(tr); // Add actions to the new row
    tbody.appendChild(tr);
    const newCell = tr.querySelector('.q-text');
    if (newCell) setTimeout(() => placeCursorAtEnd(newCell), 50);
}
function deleteCurrentQuestion() { if (!focusedEditable) { showModal('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø³Ø¤Ø§Ù„ Ù„Ø­Ø°ÙÙ‡ Ø£ÙˆÙ„Ø§Ù‹.'); return; } const questionRow = focusedEditable.closest('tr'); if (questionRow && questionRow.parentElement?.tagName === 'TBODY') { questionRow.remove(); } else { showModal('Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„ ØµØ§Ù„Ø­ Ù„Ù„Ø­Ø°Ù ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø­Ø¯Ø¯.'); } }
function appendRowActions(row) { const actionsDiv = document.createElement('div'); actionsDiv.className = 'row-actions'; actionsDiv.innerHTML = `<button class="row-delete-btn" title="Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„">&times;</button><button class="row-save-template-btn" title="Ø­ÙØ¸ ÙƒÙ‚Ø§Ù„Ø¨">ğŸ’¾</button>`; row.appendChild(actionsDiv); }
function initializeRowActions() { workspace.querySelectorAll('.questions-table tbody tr').forEach(row => { if (!row.querySelector('.row-actions')) { appendRowActions(row); } }); }


// --- UI & NAVIGATION ---
function goToPage(index) { const pages = workspace.querySelectorAll('.page'); if (index >= 0 && index < pages.length) { pages[index].scrollIntoView({ behavior: 'smooth', block: 'center' }); currentPageIndex = index; updatePaginationUI(); } }
function updatePaginationUI() { const pages = workspace.querySelectorAll('.page'); const pageCount = pages.length; document.getElementById('page-indicator').textContent = `${currentPageIndex + 1} / ${pageCount}`; document.getElementById('prev-page-btn').disabled = (currentPageIndex === 0); document.getElementById('next-page-btn').disabled = (currentPageIndex >= pageCount - 1); }
function updatePageZoom() { const zoomValue = zoomSlider.value; zoomLabel.textContent = `${zoomValue}%`; const scale = zoomValue / 100; const pages = workspace.querySelectorAll('.page'); pages.forEach(page => { page.style.transform = `scale(${scale})`; }); workspace.style.overflowX = zoomValue > 45 ? 'auto' : 'hidden'; }

// --- SELECTION HANDLING ---
function saveSelection() { if (window.getSelection) { const sel = window.getSelection(); if (sel.getRangeAt && sel.rangeCount) savedSelection = sel.getRangeAt(0); } else if (document.selection?.createRange) savedSelection = document.selection.createRange(); else savedSelection = null; }
function restoreSelection() { if (savedSelection) { if (window.getSelection) { const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(savedSelection); } else if (document.selection?.select) savedSelection.select(); } }

// --- TEXT FORMATTING ---
function execCmd(cmd, value = null) { document.execCommand(cmd, false, value); if(focusedEditable) focusedEditable.focus(); }
function changeSelectedFontSize(delta) { restoreSelection(); const selection = window.getSelection(); if (!selection.rangeCount) return; const range = selection.getRangeAt(0); let parentElement = range.commonAncestorContainer; if (parentElement.nodeType !== Node.ELEMENT_NODE) parentElement = parentElement.parentElement; const currentSize = parseFloat(window.getComputedStyle(parentElement).fontSize); const newSize = Math.max(8, currentSize + delta); document.execCommand('fontSize', false, '1'); const fontElements = (focusedEditable || workspace).querySelectorAll('font[size="1"]'); fontElements.forEach(el => { el.removeAttribute('size'); el.style.fontSize = `${newSize}px`; }); }
function setVerticalAlign(align) { if (!focusedEditable) return; const cell = focusedEditable.closest('td'); if (cell) cell.style.verticalAlign = align; }
function changeLineHeight(delta) { if (!focusedEditable) return; const blockElement = focusedEditable.closest('td, div, p'); if (blockElement) { const currentLineHeight = parseFloat(blockElement.style.lineHeight) || 1.6; const newLineHeight = Math.max(1.0, currentLineHeight + delta); blockElement.style.lineHeight = newLineHeight.toFixed(2); } }
function setTextOrientation(orientation) { if (!focusedEditable) return; const blockElement = focusedEditable.closest('td, div, p'); if (blockElement) { blockElement.style.writingMode = orientation; } }
function toggleTextRotation() { if (!focusedEditable) return; const blockElement = focusedEditable.closest('td, div, p'); if (blockElement) { const currentTransform = blockElement.style.transform; if (currentTransform.includes('rotate(180deg)')) { blockElement.style.transform = ''; } else { blockElement.style.transform = 'rotate(180deg)'; } } }

// --- TEMPLATES & SHUFFLE ---
function saveSelectionAsTemplate() {
    restoreSelection();
    const sel = window.getSelection();
    if (sel.isCollapsed) return;
    const range = sel.getRangeAt(0);
    const content = range.cloneContents();
    const tempDiv = document.createElement('div');
    tempDiv.appendChild(content);
    saveQuestionTemplate(tempDiv.innerHTML);
}
function shuffleQuestions() {
    showModal('ØªØ£ÙƒÙŠØ¯ Ø®Ù„Ø· Ø§Ù„Ø£Ø³Ø¦Ù„Ø©', '<p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø´ÙƒÙ„ Ø¹Ø´ÙˆØ§Ø¦ÙŠØŸ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø±Ø©.</p>', (confirmed) => {
        if (confirmed) {
            const allRows = Array.from(workspace.querySelectorAll('.questions-table tbody tr'));
            const shuffledRows = allRows.sort(() => Math.random() - 0.5);
            workspace.querySelectorAll('.questions-table tbody').forEach(tbody => tbody.innerHTML = '');
            let currentPageIndex = 0; let pages = workspace.querySelectorAll('.page');
            shuffledRows.forEach((row, index) => {
                let currentPage = pages[currentPageIndex];
                if (isPageOverflowing(currentPage)) {
                    currentPageIndex++;
                    if (currentPageIndex >= pages.length) {
                        addContinuationPage();
                        pages = workspace.querySelectorAll('.page');
                    }
                    currentPage = pages[currentPageIndex];
                }
                const tbody = currentPage.querySelector('.questions-table tbody');
                row.cells[0].textContent = index + 1;
                tbody.appendChild(row);
            });
            checkAllPagesForOverflow();
        }
    });
}

// --- PDF EXPORT ---
async function exportPDF() { if (activeItem) deselectItem(); document.getElementById('save-status').textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ù…Ù„Ù PDF...'; modalContainer.innerHTML = `<div class="modal-box"><h3>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±...</h3><p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø©.</p><div class="loader" style="display: block;"></div></div>`; modalContainer.style.display = 'flex'; try { const { jsPDF } = window.jspdf; const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4', putOnlyUsedFonts: true }); const originalPages = Array.from(workspace.querySelectorAll('.page')); const printContainer = document.createElement('div'); printContainer.style.position = 'absolute'; printContainer.style.left = '-9999px'; printContainer.style.top = '0'; document.body.appendChild(printContainer); for(let i = 0; i < originalPages.length; i++) { const originalPage = originalPages[i]; const clonedPage = originalPage.cloneNode(true); clonedPage.style.transform = 'scale(1)'; clonedPage.style.boxShadow = 'none'; clonedPage.style.margin = '0'; clonedPage.style.backgroundColor = '#ffffff'; clonedPage.style.color = '#000000'; clonedPage.querySelectorAll('*').forEach(el => { el.style.color = '#000000'; }); clonedPage.querySelectorAll('.row-actions, .item-controls').forEach(el => el.remove()); clonedPage.querySelectorAll('.questions-table th').forEach(th => { th.style.backgroundColor = '#f3f3f3'; }); printContainer.appendChild(clonedPage); if(i > 0) pdf.addPage(); const canvas = await html2canvas(clonedPage, { scale: 3, useCORS: true, logging: false, width: clonedPage.offsetWidth, height: clonedPage.offsetHeight, }); pdf.addImage(canvas.toDataURL('image/png', 1.0), 'PNG', 0, 0, 210, 297, undefined, 'FAST'); printContainer.removeChild(clonedPage); } document.body.removeChild(printContainer); const title = workspace.querySelector('.exam-title-main')?.textContent.trim() || 'exam'; pdf.save(`${title}.pdf`); document.getElementById('save-status').textContent = 'ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!'; } catch (error) { console.error("PDF Export Error:", error); document.getElementById('save-status').textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±.'; showModal('Ø®Ø·Ø£', 'Ø¹Ø°Ø±Ø§Ù‹, Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'); } finally { modalContainer.style.display = 'none'; } }

// --- INSERTIONS (IMAGES, MATH, ETC.) ---
function insertNodeAtCaret(node) { 
    if (!focusedEditable) return; 
    focusedEditable.focus(); 
    restoreSelection(); 
    const sel = window.getSelection(); 
    if (!sel.rangeCount) return; 
    const range = sel.getRangeAt(0); 
    range.deleteContents(); 
    
    if (node.classList.contains('inserted-item')) {
      if (!node.querySelector('table')) {
          node.querySelectorAll('[contenteditable="true"]').forEach(el => el.setAttribute('contenteditable', 'false'));
      }
      
      const wrapper = document.createElement('span');
      wrapper.style.position = 'relative';
      wrapper.style.display = 'inline-block';
      wrapper.style.width = node.style.width;
      wrapper.style.height = node.style.height;
      node.style.top = '0px';
      node.style.left = '0px';
      wrapper.appendChild(node);
      
      range.insertNode(wrapper);

      const spaceNode = document.createTextNode('\u200B'); 
      if (wrapper.nextSibling) wrapper.parentNode.insertBefore(spaceNode, wrapper.nextSibling); 
      else wrapper.parentNode.appendChild(spaceNode); 
      
      const newRange = document.createRange(); 
      newRange.setStartAfter(spaceNode); 
      newRange.collapse(true); 
      sel.removeAllRanges(); 
      sel.addRange(newRange); 
    } else {
      range.insertNode(node);
      range.setStartAfter(node);
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
    }
}
function handleImageUpload(event, selector, isLogo) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = e => { const dataUrl = e.target.result; if (isLogo) { const logoContainer = workspace.querySelector('.logo-container'); logoContainer.innerHTML = `<img src="${dataUrl}" alt="logo">`; } else { const imgWrapper = document.createElement('div'); imgWrapper.className = 'inserted-item'; imgWrapper.style.width = '150px'; imgWrapper.style.height = 'auto'; imgWrapper.innerHTML = `<img src="${dataUrl}" />`; insertNodeAtCaret(imgWrapper); } }; reader.readAsDataURL(file); event.target.value = ''; }
function createMathTemplate(innerHTML) { const wrapper = document.createElement('span'); wrapper.style.display = 'inline-block'; wrapper.style.verticalAlign = 'middle'; wrapper.className = 'math-template'; wrapper.innerHTML = innerHTML; return wrapper; }
function insertFraction() { insertNodeAtCaret(createMathTemplate(`<span style="display:inline-block; text-align:center; vertical-align:middle;"><div contenteditable="true" style="min-width:20px; border-bottom:1.5px solid currentColor; padding:0 4px;">&nbsp;</div><div contenteditable="true" style="min-width:20px; padding:0 4px;">&nbsp;</div></span>`)); }
function insertSqrt() { const sqrtHTML = `<span style="display: inline-flex; vertical-align: middle;">`+ `<span style="font-size: 1.6em; line-height: 1; margin-top: 0.3em;">&radic;</span>`+ `<span contenteditable="true" style="display: block; border-top: 2px solid currentColor; padding: 0 5px; min-width: 40px; margin-left: -0.1em;">&nbsp;</span>`+ `</span>`; insertNodeAtCaret(createMathTemplate(sqrtHTML)); }
function insertPowerTemplate() { insertNodeAtCaret(createMathTemplate(`<span contenteditable="true" style="display:inline-block;"></span><sup contenteditable="true"></sup>`)); }
function insertMathTemplate(html) { insertNodeAtCaret(createMathTemplate(html)); }

// --- WORKSPACE INTERACTIONS ---
function handleWorkspaceClick(e) { 
    if (e.target.closest('.logo-container')) { document.getElementById('logo-input').click(); return; } 
    if (e.target.classList.contains('page-delete-btn')) { if(workspace.querySelectorAll('.page').length > 1) { e.target.closest('.page').remove(); updatePaginationUI(); } else { showModal('Ø®Ø·Ø£', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„ØµÙØ­Ø© Ø§Ù„ÙˆØ­ÙŠØ¯Ø©.'); } return; } 
    if (e.target.classList.contains('row-delete-btn')) { e.target.closest('tr').remove(); return; } 
    if (e.target.classList.contains('row-save-template-btn')) { const questionCell = e.target.closest('tr').querySelector('.q-text'); if(questionCell) saveQuestionTemplate(questionCell.innerHTML); return; } 
    
    const clickedItem = e.target.closest('.inserted-item');
    if (clickedItem) {
        if(activeItem !== clickedItem) selectItem(clickedItem);
    } else if (activeItem && !e.target.closest('.item-controls') && !e.target.closest('#contextual-toolbar')) {
        deselectItem();
    }
}

// --- ITEM SELECTION & MANIPULATION (DRAG, RESIZE, ROTATE) ---
function selectItem(item) {
    if (activeItem) deselectItem();
    activeItem = item;
    item.classList.add('selected');

    const controls = document.createElement('div');
    controls.className = 'item-controls';
    controls.innerHTML = `<div class="resize-handle" title="ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ±"></div><div class="rotate-handle" title="ØªØ¯ÙˆÙŠØ±"></div><div class="delete-handle" title="Ø­Ø°Ù">&times;</div>`;
    item.appendChild(controls);

    // Attach listeners for drag/resize/rotate
    controls.querySelector('.resize-handle').addEventListener('mousedown', initAction);
    controls.querySelector('.rotate-handle').addEventListener('mousedown', initAction);
    controls.querySelector('.delete-handle').addEventListener('click', deleteActiveItem);
    item.addEventListener('mousedown', initAction);
    controls.querySelector('.resize-handle').addEventListener('touchstart', initAction, { passive: false });
    controls.querySelector('.rotate-handle').addEventListener('touchstart', initAction, { passive: false });
    item.addEventListener('touchstart', initAction, { passive: false });
    
    document.getElementById('rotate-item-btn').disabled = false;

    //  NEW CONTEXTUAL TOOLBAR LOGIC
    contextualToolbar.innerHTML = '';
    if (item.querySelector('table')) {
        populateTableControls(contextualToolbar);
    } else {
        populateShapeControls(contextualToolbar);
    }
    contextualToolbar.style.display = 'flex';
}

function deselectItem() {
    if (!activeItem) return;
    
    activeItem.classList.remove('selected');
    const controls = activeItem.querySelector('.item-controls');
    if (controls) controls.remove();

    // Remove event listeners to prevent memory leaks
    activeItem.removeEventListener('mousedown', initAction);
    activeItem.removeEventListener('touchstart', initAction);
    
    activeItem = null;
    document.getElementById('rotate-item-btn').disabled = true;

    // HIDE CONTEXTUAL TOOLBAR
    contextualToolbar.style.display = 'none';
}

function deleteActiveItem() { if (activeItem) { const itemToDelete = activeItem; deselectItem(); itemToDelete.parentElement.remove(); /* Remove the wrapper too */ } }
function rotateActiveItem() { if (!activeItem) return; const transform = window.getComputedStyle(activeItem).transform; let currentAngle = 0; if (transform && transform !== 'none') { const matrix = new DOMMatrixReadOnly(transform); currentAngle = Math.atan2(matrix.b, matrix.a) * (180 / Math.PI); } const newAngle = Math.round(currentAngle + 45); activeItem.style.transform = `rotate(${newAngle}deg)`; }
let initialPos, initialSize, actionType; function initAction(e) {
    if (e.target.closest('.inserted-item') && !e.target.classList.contains('resize-handle') && !e.target.classList.contains('rotate-handle')) {
        if (activeItem !== e.target.closest('.inserted-item')) selectItem(e.target.closest('.inserted-item'));
    }
    if (!activeItem) return;
    e.preventDefault();
    if (e.target.classList.contains('resize-handle')) actionType = 'resize';
    else if (e.target.classList.contains('rotate-handle')) actionType = 'rotate';
    else actionType = 'move';

    const rect = activeItem.getBoundingClientRect();
    const isTouchEvent = e.type.startsWith('touch');
    const clientX = isTouchEvent ? e.touches[0].clientX : e.clientX;
    const clientY = isTouchEvent ? e.touches[0].clientY : e.clientY;
    initialPos = { x: clientX, y: clientY, cx: rect.left + rect.width / 2, cy: rect.top + rect.height / 2, itemX: parseFloat(activeItem.style.left) || 0, itemY: parseFloat(activeItem.style.top) || 0 };
    const styles = window.getComputedStyle(activeItem);
    initialSize = { w: parseFloat(styles.width), h: parseFloat(styles.height) };
    const matrix = new DOMMatrixReadOnly(styles.transform === 'none' ? '' : styles.transform);
    const currentAngle = Math.atan2(matrix.b, matrix.a) * (180 / Math.PI);
    initialPos.startAngle = Math.atan2(initialPos.y - initialPos.cy, initialPos.x - initialPos.cx) * (180 / Math.PI) - currentAngle;
    window.addEventListener('mousemove', doAction);
    window.addEventListener('mouseup', stopAction);
    window.addEventListener('touchmove', doAction, { passive: false });
    window.addEventListener('touchend', stopAction);
}
function doAction(e) { if (!activeItem) return; const isTouchEvent = e.type.startsWith('touch'); if (isTouchEvent) e.preventDefault(); const clientX = isTouchEvent ? e.touches[0].clientX : e.clientX; const clientY = isTouchEvent ? e.touches[0].clientY : e.clientY;
    const dx = clientX - initialPos.x; const dy = clientY - initialPos.y;
    if (actionType === 'resize') { activeItem.style.width = Math.max(20, initialSize.w + dx) + 'px'; activeItem.style.height = Math.max(20, initialSize.h + dy) + 'px'; activeItem.parentElement.style.width = activeItem.style.width; activeItem.parentElement.style.height = activeItem.style.height; }
    else if (actionType === 'rotate') { const moveAngle = Math.atan2(clientY - initialPos.cy, clientX - initialPos.cx) * (180 / Math.PI); const rotation = moveAngle - initialPos.startAngle; activeItem.style.transform = `rotate(${rotation}deg)`; }
    else if (actionType === 'move') { moveActiveItem(dx, dy, true); initialPos.itemX += dx; initialPos.itemY += dy; initialPos.x = clientX; initialPos.y = clientY; }
}
function stopAction() { window.removeEventListener('mousemove', doAction); window.removeEventListener('mouseup', stopAction); window.removeEventListener('touchmove', doAction); window.removeEventListener('touchend', stopAction); }

// --- MODALS ---
function showModal(title, content, onConfirm) { modalContainer.innerHTML = ''; const modalBox = document.createElement('div'); modalBox.className = 'modal-box'; let modalHTML = `<h3>${title}</h3><div>${content}</div>`; const actions = onConfirm ? `<div class="modal-actions"><button id="modal-cancel-btn" class="btn">Ø¥Ù„ØºØ§Ø¡</button><button id="modal-confirm-btn" class="btn">Ù…ÙˆØ§ÙÙ‚</button></div>` : `<div class="modal-actions"><button id="modal-close-btn" class="btn">Ø¥ØºÙ„Ø§Ù‚</button></div>`; modalHTML += actions; modalBox.innerHTML = modalHTML; modalContainer.appendChild(modalBox); modalContainer.style.display = 'flex'; const closeModal = () => modalContainer.style.display = 'none'; if (onConfirm) { document.getElementById('modal-confirm-btn').onclick = () => { onConfirm(true); closeModal(); }; document.getElementById('modal-cancel-btn').onclick = () => { onConfirm(false); closeModal(); }; } else { document.getElementById('modal-close-btn').onclick = closeModal; } modalContainer.onclick = (e) => { if(e.target === modalContainer) closeModal(); }; }
function showBorderModal() { const content = `<p>Ø§Ø®ØªØ± ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª.</p><div class="border-options"><button class="btn" data-border-class=""><div class="border-preview"></div><span>Ø¹Ø§Ø¯ÙŠ</span></button><button class="btn" data-border-class="border-double"><div class="border-preview border-double"></div><span>Ù…Ø²Ø¯ÙˆØ¬</span></button><button class="btn" data-border-class="border-dotted"><div class="border-preview border-dotted"></div><span>Ù…Ù†Ù‚Ø·</span></button><button class="btn" data-border-class="border-dashed-thick"><div class="border-preview" style="border: 2px dashed var(--text-primary);"></div><span>Ù…ØªÙ‚Ø·Ø¹ Ø¹Ø±ÙŠØ¶</span></button><button class="btn" data-border-class="border-double-color"><div class="border-preview" style="border: 4px double var(--accent);"></div><span>Ù…Ø²Ø¯ÙˆØ¬ Ù…Ù„ÙˆÙ†</span></button><button class="btn" data-border-class="border-gradient"><div class="border-preview" style="border: 4px solid; border-image: linear-gradient(45deg, var(--primary), var(--accent)) 1;"></div><span>Ù…ØªØ¯Ø±Ø¬</span></button><button class="btn" data-border-class="border-none"><div style="width:60px; height:40px; margin-bottom:5px; display:flex; align-items:center; justify-content:center; color: var(--text-muted);">(Ù„Ø§ ÙŠÙˆØ¬Ø¯)</div><span>Ø¨Ø¯ÙˆÙ†</span></button></div>`; showModal('ØªØ®ØµÙŠØµ Ø¥Ø·Ø§Ø± Ø§Ù„ØµÙØ­Ø©', content); document.querySelectorAll('.border-options .btn').forEach(button => { button.addEventListener('click', () => { const borderClass = button.dataset.borderClass; workspace.querySelectorAll('.page').forEach(page => { page.classList.remove('border-double', 'border-dotted', 'border-none', 'border-dashed-thick', 'border-double-color', 'border-gradient'); if (borderClass) { page.classList.add(borderClass); } }); modalContainer.style.display = 'none'; }); }); }
function showTableModal() { const content = `<div class="form-group"><label for="table-rows">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ:</label><input type="number" id="table-rows" value="3" min="1"></div><div class="form-group"><label for="table-cols">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©:</label><input type="number" id="table-cols" value="2" min="1"></div>`; showModal('Ø¥Ø¯Ø±Ø§Ø¬ Ø¬Ø¯ÙˆÙ„', content, (confirmed) => { if (confirmed) { const rows = document.getElementById('table-rows').value, cols = document.getElementById('table-cols').value; let tableHTML = '<table><tbody>'; for (let i = 0; i < rows; i++) { tableHTML += '<tr>'; for (let j = 0; j < cols; j++) { tableHTML += '<td contenteditable="true">&nbsp;</td>'; } tableHTML += '</tr>'; } tableHTML += '</tbody></table>'; const tableWrapper = document.createElement('div'); tableWrapper.className = 'inserted-item'; tableWrapper.style.width = '250px'; tableWrapper.style.height = 'auto'; tableWrapper.innerHTML = tableHTML; insertNodeAtCaret(tableWrapper); } }); }

// --- CONTEXTUAL TOOLBARS AND CONTROLS ---
function populateTableControls(toolbar) {
    toolbar.innerHTML = `
        <div class="controls-row">
            <span style="font-weight: bold; margin-inline-end: 10px;">Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„:</span>
            <button id="ctx-tbl-add-row-above" class="btn" title="Ø¥Ø¶Ø§ÙØ© ØµÙ Ù„Ù„Ø£Ø¹Ù„Ù‰">â• ØµÙ â†‘</button>
            <button id="ctx-tbl-add-row-below" class="btn" title="Ø¥Ø¶Ø§ÙØ© ØµÙ Ù„Ù„Ø£Ø³ÙÙ„">â• ØµÙ â†“</button>
            <button id="ctx-tbl-add-col-left" class="btn" title="Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ù„Ù„ÙŠØ³Ø§Ø±">â• Ø¹Ù…ÙˆØ¯ â†</button>
            <button id="ctx-tbl-add-col-right" class="btn" title="Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ù„Ù„ÙŠÙ…ÙŠÙ†">â• Ø¹Ù…ÙˆØ¯ â†’</button>
        </div>
        <div class="controls-row">
            <button id="ctx-tbl-del-row" class="btn" title="Ø­Ø°Ù Ø§Ù„ØµÙ">ğŸ—‘ï¸ ØµÙ</button>
            <button id="ctx-tbl-del-col" class="btn" title="Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙˆØ¯">ğŸ—‘ï¸ Ø¹Ù…ÙˆØ¯</button>
            <button id="ctx-tbl-merge-cells" class="btn" title="Ø¯Ù…Ø¬ Ø§Ù„Ø®Ù„Ø§ÙŠØ§">Ø¯Ù…Ø¬</button>
            <button id="ctx-tbl-split-cells" class="btn" title="ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø®Ù„ÙŠØ©">ØªÙ‚Ø³ÙŠÙ…</button>
        </div>`;
    document.getElementById('ctx-tbl-add-row-above').addEventListener('click', () => modifyTable('addRow', 'above'));
    document.getElementById('ctx-tbl-add-row-below').addEventListener('click', () => modifyTable('addRow', 'below'));
    document.getElementById('ctx-tbl-add-col-left').addEventListener('click', () => modifyTable('addCol', 'left'));
    document.getElementById('ctx-tbl-add-col-right').addEventListener('click', () => modifyTable('addCol', 'right'));
    document.getElementById('ctx-tbl-del-row').addEventListener('click', () => modifyTable('deleteRow'));
    document.getElementById('ctx-tbl-del-col').addEventListener('click', () => modifyTable('deleteCol'));
    document.getElementById('ctx-tbl-merge-cells').addEventListener('click', () => modifyTable('merge'));
    document.getElementById('ctx-tbl-split-cells').addEventListener('click', () => modifyTable('split'));
}

function populateShapeControls(toolbar) {
    toolbar.innerHTML = `
        <div class="controls-row">
            <span style="font-weight: bold; margin-inline-end: 10px;">ØªØ­Ø±ÙŠÙƒ:</span>
            <button id="ctx-move-up" class="btn" title="ØªØ­Ø±ÙŠÙƒ Ù„Ù„Ø£Ø¹Ù„Ù‰">â†‘</button>
            <button id="ctx-move-down" class="btn" title="ØªØ­Ø±ÙŠÙƒ Ù„Ù„Ø£Ø³ÙÙ„">â†“</button>
            <button id="ctx-move-left" class="btn" title="ØªØ­Ø±ÙŠÙƒ Ù„Ù„ÙŠØ³Ø§Ø±">â†</button>
            <button id="ctx-move-right" class="btn" title="ØªØ­Ø±ÙŠÙƒ Ù„Ù„ÙŠÙ…ÙŠÙ†">â†’</button>
        </div>
        <div class="controls-row">
            <span style="font-weight: bold; margin-inline-end: 10px;">Ø¹Ø±Ø¶:</span>
            <input type="range" id="ctx-size-slider" min="20" max="500" value="120" style="width: 150px; direction: ltr;">
            <label id="ctx-size-label" style="min-width: 50px; text-align: right;">120px</label>
        </div>`;
    const moveAmount = 5;
    document.getElementById('ctx-move-up').addEventListener('click', () => moveActiveItem(0, -moveAmount));
    document.getElementById('ctx-move-down').addEventListener('click', () => moveActiveItem(0, moveAmount));
    document.getElementById('ctx-move-left').addEventListener('click', () => moveActiveItem(-moveAmount, 0));
    document.getElementById('ctx-move-right').addEventListener('click', () => moveActiveItem(moveAmount, 0));
    const sizeSlider = document.getElementById('ctx-size-slider');
    const sizeLabel = document.getElementById('ctx-size-label');
    if (activeItem) { const currentWidth = parseFloat(activeItem.style.width) || 120; sizeSlider.value = currentWidth; sizeLabel.textContent = `${Math.round(currentWidth)}px`; }
    sizeSlider.addEventListener('input', () => {
        if (!activeItem) return;
        const newWidth = sizeSlider.value;
        activeItem.style.width = newWidth + 'px';
        if (activeItem.parentElement.style.position === 'relative') { activeItem.parentElement.style.width = newWidth + 'px'; }
        sizeLabel.textContent = `${Math.round(newWidth)}px`;
    });
}

function moveActiveItem(dx, dy, isDrag = false) {
    if (!activeItem) return;
    let currentLeft = parseFloat(activeItem.style.left) || 0;
    let currentTop = parseFloat(activeItem.style.top) || 0;
    activeItem.style.left = (currentLeft + dx) + 'px';
    activeItem.style.top = (currentTop + dy) + 'px';
}

function modifyTable(action, option) {
    const tableInActiveItem = activeItem?.querySelector('table');
    if (!tableInActiveItem) {
        showModal('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø¬Ø¯ÙˆÙ„ Ù…Ø¯Ø±Ø¬ Ø£ÙˆÙ„Ø§Ù‹.');
        return;
    }
    
    let currentCell = focusedEditable?.closest('td, th');
    if (!currentCell || !tableInActiveItem.contains(currentCell)) {
        currentCell = tableInActiveItem.querySelector('td, th');
    }

    if (!currentCell) {
        showModal('Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø®Ù„ÙŠØ© Ù„Ù„Ø¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡Ø§ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯.');
        return;
    }
    
    const row = currentCell.closest('tr');
    const table = currentCell.closest('table');
    if (!row || table !== tableInActiveItem) return;

    const rowIndex = row.rowIndex;
    const colIndex = currentCell.cellIndex;

    switch (action) {
        case 'addRow': const newRow = table.insertRow(option === 'above' ? rowIndex : rowIndex + 1); for (let i = 0; i < row.cells.length; i++) { const newCell = newRow.insertCell(i); newCell.contentEditable = true; newCell.innerHTML = '&nbsp;'; } break;
        case 'addCol': for (let i = 0; i < table.rows.length; i++) { const newCell = table.rows[i].insertCell(option === 'left' ? colIndex : colIndex + 1); newCell.contentEditable = true; newCell.innerHTML = '&nbsp;'; } break;
        case 'deleteRow': if (table.rows.length > 1) table.deleteRow(rowIndex); break;
        case 'deleteCol': if (row.cells.length > 1) { for (let i = 0; i < table.rows.length; i++) { table.rows[i].deleteCell(colIndex); } } break;
        case 'merge': document.execCommand('mergeCells'); break;
        case 'split': document.execCommand('splitCell'); break;
    }
}


// --- SHAPES, SYMBOLS, MATH EQUATIONS ---
const shapes = {
    rectangle: { name: 'Ù…Ø³ØªØ·ÙŠÙ„', svg: '<svg viewBox="0 0 100 60"><rect x="0" y="0" width="100" height="60" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    circle: { name: 'Ø¯Ø§Ø¦Ø±Ø©', svg: '<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    triangle: { name: 'Ù…Ø«Ù„Ø«', svg: '<svg viewBox="0 0 100 86.6"><polygon points="50,0 100,86.6 0,86.6" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    line: { name: 'Ø®Ø·', svg: '<svg viewBox="0 0 100 10"><line x1="0" y1="5" x2="100" y2="5" stroke="currentColor" stroke-width="2"/></svg>' },
    right_arrow: { name: 'Ø³Ù‡Ù…', svg: '<svg viewBox="0 0 100 30"><polygon points="0,10 70,10 70,0 100,15 70,30 70,20 0,20" fill="currentColor"/></svg>' },
    ellipse: { name: 'Ù‚Ø·Ø¹ Ù†Ø§Ù‚Øµ', svg: '<svg viewBox="0 0 100 50"><ellipse cx="50" cy="25" rx="48" ry="23" fill="none" stroke="currentColor" stroke-width="2" /></svg>' },
    star: { name: 'Ù†Ø¬Ù…Ø©', svg: '<svg viewBox="0 0 100 100"><polygon points="50,5 61,40 98,40 68,62 79,96 50,75 21,96 32,62 2,40 39,40" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    hexagon: { name: 'Ø³Ø¯Ø§Ø³ÙŠ', svg: '<svg viewBox="0 0 100 86.6"><polygon points="25,0 75,0 100,43.3 75,86.6 25,86.6 0,43.3" fill="none" stroke="currentColor" stroke-width="2"/></svg>' }
};

const physicsShapes = {
    resistor: { name: 'Ù…Ù‚Ø§ÙˆÙ…Ø© (R)', svg: '<svg viewBox="0 0 100 30"><path d="M0 15 L10 15 L15 5 L25 25 L35 5 L45 25 L55 5 L65 25 L75 5 L85 25 L90 15 L100 15" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    capacitor: { name: 'Ù…ÙƒØ«Ù (C)', svg: '<svg viewBox="0 0 100 40"><path d="M0 20 L40 20 M60 20 L100 20 M40 5 L40 35 M60 5 L60 35" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    inductor: { name: 'Ù…Ù„Ù Ø­Ø« (L)', svg: '<svg viewBox="0 0 100 30"><path d="M0 15 L10 15 C 10 5, 20 5, 20 15 S 30 25, 40 15 S 50 5, 60 15 S 70 25, 80 15 L90 15 L100 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>' },
    battery_single: { name: 'Ø¨Ø·Ø§Ø±ÙŠØ© (V)', svg: '<svg viewBox="0 0 100 40"><path d="M0 20 L35 20 M65 20 L100 20 M35 5 L35 35 M50 12 L50 28" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    ac_source: { name: 'Ù…ØµØ¯Ø± Ù…ØªØ±Ø¯Ø¯', svg: '<svg viewBox="0 0 100 40"><path d="M0 20 L30 20 M70 20 L100 20" stroke="currentColor" stroke-width="2"/><circle cx="50" cy="20" r="20" fill="none" stroke="currentColor" stroke-width="2"/><path d="M40 20 C 45 10, 55 30, 60 20" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    ground: { name: 'Ø£Ø±Ø¶ÙŠ', svg: '<svg viewBox="0 0 40 40"><path d="M20 0 L20 20 M5 20 L35 20 M10 27 L30 27 M15 34 L25 34" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    voltmeter: { name: 'ÙÙˆÙ„ØªÙ…ÙŠØªØ±', svg: '<svg viewBox="0 0 100 50"><circle cx="50" cy="25" r="24" fill="none" stroke="currentColor" stroke-width="2"/><text x="50" y="32" font-size="24" text-anchor="middle" fill="currentColor" font-weight="bold">V</text></svg>' },
    ammeter: { name: 'Ø£Ù…ÙŠØªØ±', svg: '<svg viewBox="0 0 100 50"><circle cx="50" cy="25" r="24" fill="none" stroke="currentColor" stroke-width="2"/><text x="50" y="32" font-size="24" text-anchor="middle" fill="currentColor" font-weight="bold">A</text></svg>' },
    impedance: { name: 'Ù…Ø¹Ø§ÙˆÙ‚Ø© (Z)', svg: '<svg viewBox="0 0 100 30" fill="none" stroke="currentColor" stroke-width="2"><path d="M0 15 L20 15 L80 15 L100 15"/><rect x="20" y="5" width="60" height="20"/></svg>'},
    lens_convex: { name: 'Ø¹Ø¯Ø³Ø© Ù…Ø­Ø¯Ø¨Ø©', svg: '<svg viewBox="0 0 50 100"><path d="M25 0 C 50 25, 50 75, 25 100 C 0 75, 0 25, 25 0 Z" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    lens_concave: { name: 'Ø¹Ø¯Ø³Ø© Ù…Ù‚Ø¹Ø±Ø©', svg: '<svg viewBox="0 0 50 100"><path d="M0 0 C 25 25, 25 75, 0 100 M50 0 C 25 25, 25 75, 50 100" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    prism: { name: 'Ù…Ù†Ø´ÙˆØ±', svg: '<svg viewBox="0 0 100 87"><polygon points="50,0 100,86.6 0,86.6" fill="none" stroke="currentColor" stroke-width="2"/></svg>'},
};

function showShapeModal() { 
    let shapeGridHTML = '<div><h4>Ø£Ø´ÙƒØ§Ù„ Ø£Ø³Ø§Ø³ÙŠØ©</h4><div class="shape-grid">'; 
    for (const [key, shape] of Object.entries(shapes)) { shapeGridHTML += `<div class="shape-item" data-shape-svg='${escapeHtml(shape.svg)}'>${shape.svg}<small>${shape.name}</small></div>`; } 
    shapeGridHTML += '</div>';

    shapeGridHTML += '<h4 style="margin-top: 15px;">Ù…ÙƒÙˆÙ†Ø§Øª Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© ÙˆØ¨ØµØ±ÙŠØ§Øª</h4><div class="shape-grid">';
    for (const [key, shape] of Object.entries(physicsShapes)) { shapeGridHTML += `<div class="shape-item" data-shape-svg='${escapeHtml(shape.svg)}'>${shape.svg}<small>${shape.name}</small></div>`; }
    shapeGridHTML += '</div></div>';

    showModal('Ø§Ø®ØªØ± Ø´ÙƒÙ„Ø§Ù‹', shapeGridHTML); 
    document.querySelectorAll('.shape-item').forEach(item => { item.onclick = () => { insertShape(item.dataset.shapeSvg); modalContainer.style.display = 'none'; }; }); 
} 
function insertShape(svgCode) { const shapeWrapper = document.createElement('div'); shapeWrapper.className = 'inserted-item'; shapeWrapper.style.width = '120px'; shapeWrapper.style.height = '120px'; shapeWrapper.innerHTML = svgCode; insertNodeAtCaret(shapeWrapper); }

const mathEquations = { 
    quadratic: { name: 'Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø¹Ø§Ù…', html: `<span dir="rtl" style="font-family: var(--font-formal); font-size: 1.2em;">Ø³ = <span style="display:inline-block; text-align:center; vertical-align:middle;"><div style="min-width:120px; border-bottom:1.5px solid currentColor; padding:0 4px;">&minus;Ø¨ &plusmn; &radic;<span style="border-top:1.5px solid currentColor; padding: 0 3px;">Ø¨&supÙ¢; &minus; Ù¤ Ø£ Ø¬</span></div><div style="min-width:30px; padding:0 4px;">Ù¢ Ø£</div></span></span>` }, 
    pythagorean: { name: 'Ù†Ø¸Ø±ÙŠØ© ÙÙŠØ«Ø§ØºÙˆØ±Ø³', html: `<span dir="ltr" style="font-family: var(--font-formal); font-size: 1.2em;">a&sup2; + b&sup2; = c&sup2;</span>`},
    circle_area: { name: 'Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©', html: `<span dir="rtl" style="font-family: var(--font-formal); font-size: 1.2em;">Ù… = Ø· Ù†Ù‚&supÙ¢;</span>`},
    diff_squares: { name: 'ÙØ±Ù‚ Ù…Ø±Ø¨Ø¹ÙŠÙ†', html: `<span dir="ltr" style="font-family: var(--font-formal); font-size: 1.2em;">x&sup2; &minus; y&sup2; = (x &minus; y)(x + y)</span>`}, 
    indic_fraction: { name: 'ÙƒØ³Ø± Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡Ù†Ø¯ÙŠØ©', html: `<span style="display:inline-block; text-align:center; vertical-align:middle; font-family: 'Noto Naskh Arabic'; font-size: 1.2em;"><div contenteditable="true" style="min-width:30px; border-bottom:1.5px solid currentColor; padding:0 4px;">Ù£</div><div contenteditable="true" style="min-width:30px; padding:0 4px;">Ù¤</div></span>`},
    algebra_expr: { name: 'Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¨Ø±ÙŠ', html: `<span style="font-family: var(--font-formal); font-size: 1.2em;" dir="rtl">(Ø³ + Øµ)&supÙ¢; = Ø³&supÙ¢; + Ù¢Ø³ Øµ + Øµ&supÙ¢;</span>`},
    velocity: { name: 'Ø§Ù„Ø³Ø±Ø¹Ø© (ÙÙŠØ²ÙŠØ§Ø¡)', html: `Ø¹ = <span style="display:inline-block; text-align:center; vertical-align:middle;"><div contenteditable="true" style="border-bottom:1.5px solid currentColor; padding:0 4px;">Ù</div><div contenteditable="true" style="padding:0 4px;">Ø²</div></span>`}, 
    force: { name: 'Ø§Ù„Ù‚ÙˆØ© (ÙÙŠØ²ÙŠØ§Ø¡)', html: `<span dir="rtl">Ù‚ = Ùƒ &times; Øª</span>`}, 
    density: { name: 'Ø§Ù„ÙƒØ«Ø§ÙØ© (ÙÙŠØ²ÙŠØ§Ø¡)', html: `Ø« = <span style="display:inline-block; text-align:center; vertical-align:middle;"><div contenteditable="true" style="border-bottom:1.5px solid currentColor; padding:0 4px;">Ùƒ</div><div contenteditable="true" style="padding:0 4px;">Ø­</div></span>`}, 
    ohms_law: { name: 'Ù‚Ø§Ù†ÙˆÙ† Ø£ÙˆÙ… (ÙÙŠØ²ÙŠØ§Ø¡)', html: `<span dir="rtl">Ø¬ = Øª &times; Ù…</span>`}, 
    gas_law: { name: 'Ø§Ù„ØºØ§Ø²Ø§Øª Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ© (ÙƒÙŠÙ…ÙŠØ§Ø¡)', html: `<span dir="ltr" style="font-family: var(--font-formal); font-size: 1.2em;">PV = nRT</span>`}, 
    molarity: { name: 'Ø§Ù„Ù…ÙˆÙ„Ø§Ø±ÙŠØ© (ÙƒÙŠÙ…ÙŠØ§Ø¡)', html: `Ø§Ù„ØªØ±ÙƒÙŠØ² (Ù…) = <span style="display:inline-block; text-align:center; vertical-align:middle;"><div contenteditable="true" style="border-bottom:1.5px solid currentColor; padding:0 4px;">Ø¹Ø¯Ø¯ Ù…ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø°Ø§Ø¨</div><div contenteditable="true" style="padding:0 4px;">Ø­Ø¬Ù… Ø§Ù„Ù…Ø­Ù„ÙˆÙ„ (Ù„ØªØ±)</div></span>`}};
function showMathEquationsModal() { let mathGridHTML = '<div class="math-grid">'; for (const [key, eq] of Object.entries(mathEquations)) { mathGridHTML += `<div class="math-item" data-math-html='${escapeHtml(eq.html)}'>${eq.html}<small>${eq.name}</small></div>`; } mathGridHTML += '</div>'; showModal('Ø§Ø®ØªØ± Ù…Ø¹Ø§Ø¯Ù„Ø©', mathGridHTML); document.querySelectorAll('.math-item').forEach(item => { item.onclick = () => { insertMathTemplate(item.dataset.mathHtml); modalContainer.style.display = 'none'; }; }); }

const commonSymbols = ['â‰ ', 'â‰¤', 'â‰¥', 'â‰ˆ', 'âˆ', 'Â±', 'Â°', 'âˆ ', 'â€°', 'Â§', 'Â¶', 'Â©', 'Â®', 'â„¢', 'Â·', 'â€¦', 'âˆ´', 'âˆµ'];
const physicsSymbols = ['Î±', 'Î²', 'Î³', 'Î´', 'Îµ', 'Î¸', 'Î»', 'Î¼', 'Ï€', 'Ï', 'Ïƒ', 'Ï„', 'Ï‰', 'Î¦', 'Î©', 'âˆ‡', 'Ä§', 'âˆ†', 'âˆ«', 'âˆ®', 'âˆ‚'];
const arrowSymbols = ['â†', 'â†‘', 'â†’', 'â†“', 'â†”', 'â†•', 'â†–', 'â†—', 'â†˜', 'â†™', 'â†š', 'â†›', 'â†®', 'â‡¦', 'â‡§', 'â‡¨', 'â‡©', 'â¬„', 'â‡Œ', 'â‡”', 'â‡’', 'â‡', 'â†¦', 'âŸ·', 'â½'];

function showSymbolModal() { 
    let symbolHTML = '<div>';
    
    symbolHTML += '<h4>Ø±Ù…ÙˆØ² Ø´Ø§Ø¦Ø¹Ø©</h4><div class="symbol-grid">';
    commonSymbols.forEach(symbol => { symbolHTML += `<div class="symbol-item" data-symbol="${symbol}">${symbol}</div>`; });
    symbolHTML += '</div>';

    symbolHTML += '<h4 style="margin-top: 15px;">Ø±Ù…ÙˆØ² ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ©</h4><div class="symbol-grid">';
    physicsSymbols.forEach(symbol => { symbolHTML += `<div class="symbol-item" data-symbol="${symbol}">${symbol}</div>`; });
    symbolHTML += '</div>';

    symbolHTML += '<h4 style="margin-top: 15px;">Ø£Ø³Ù‡Ù…</h4><div class="symbol-grid">';
    arrowSymbols.forEach(symbol => { symbolHTML += `<div class="symbol-item" data-symbol="${symbol}">${symbol}</div>`; });
    symbolHTML += '</div></div>';

    showModal('Ø¥Ø¯Ø±Ø§Ø¬ Ø±Ù…Ø²', symbolHTML); 
    document.querySelectorAll('.symbol-item').forEach(item => { item.onclick = () => { const symbol = item.dataset.symbol; const symbolNode = document.createElement('span'); symbolNode.textContent = symbol; insertNodeAtCaret(symbolNode); modalContainer.style.display = 'none'; }; }); 
}

// --- QUESTION TEMPLATES ---
const questionTemplates = { true_false: { name: 'Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© (âœ“) Ø£Ùˆ (Ã—)', html: `<p>Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© (âœ“) Ø£Ù…Ø§Ù… Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙˆØ¹Ù„Ø§Ù…Ø© (Ã—) Ø£Ù…Ø§Ù… Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„Ø®Ø§Ø·Ø¦Ø©:</p><p>( &nbsp; &nbsp; &nbsp;) <span contenteditable="true">Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ù‡Ù†Ø§...</span></p>`}, match: { name: 'ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠÙ†', html: `<p>ØµÙ„ Ø§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ (Ø£) Ø¨Ù…Ø§ ÙŠÙ†Ø§Ø³Ø¨Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ (Ø¨):</p><table style="width:100%; border-collapse: collapse;" border="1"><thead><tr style="text-align:center; font-weight:bold;"><td>Ø§Ù„Ø¹Ù…ÙˆØ¯ (Ø£)</td><td>Ø§Ù„Ø¹Ù…ÙˆØ¯ (Ø¨)</td></tr></thead><tbody><tr><td contenteditable="true">&nbsp;</td><td contenteditable="true">&nbsp;</td></tr><tr><td contenteditable="true">&nbsp;</td><td contenteditable="true">&nbsp;</td></tr><tr><td contenteditable="true">&nbsp;</td><td contenteditable="true">&nbsp;</td></tr></tbody></table>`}, mcq: { name: 'Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©', html: `<p contenteditable="true">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…Ù† Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚ÙˆØ§Ø³:</p><p contenteditable="true">Ø£) ... &nbsp;&nbsp;&nbsp; Ø¨) ... &nbsp;&nbsp;&nbsp; Ø¬) ... &nbsp;&nbsp;&nbsp; Ø¯) ...</p>`},};
function showQuestionTemplateModal() { let templateGridHTML = '<div class="template-list">'; for(const [key, template] of Object.entries(questionTemplates)) { templateGridHTML += `<div class="template-item" data-template-key="${key}"><span>${template.name}</span></div>`; } templateGridHTML += `<hr><h4 style="text-align:center; margin-top:10px;">Ù‚ÙˆØ§Ù„Ø¨ÙŠ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h4>`; const savedTemplates = getSavedQuestionTemplates(); savedTemplates.forEach((template, index) => { templateGridHTML += `<div class="template-item" data-saved-template-index="${index}"><span class="template-content">${escapeHtml(template.replace(/<[^>]+>/g, '').substring(0, 50))}...</span><button onclick="deleteSavedTemplate(event, ${index})">&times;</button></div>`; }); templateGridHTML += '</div>'; showModal('Ø¥Ø¯Ø±Ø§Ø¬ Ù‚Ø§Ù„Ø¨ Ø³Ø¤Ø§Ù„', templateGridHTML); document.querySelectorAll('.template-item[data-template-key]').forEach(item => { item.onclick = () => { addQuestionToTable(questionTemplates[item.dataset.templateKey].html); modalContainer.style.display = 'none'; }; }); document.querySelectorAll('.template-item[data-saved-template-index]').forEach(item => { item.onclick = () => { const index = parseInt(item.dataset.savedTemplateIndex); const savedTemplates = getSavedQuestionTemplates(); addQuestionToTable(savedTemplates[index]); modalContainer.style.display = 'none'; }; }); }
function saveQuestionTemplate(htmlContent) { let templates = getSavedQuestionTemplates(); templates.push(htmlContent); localStorage.setItem('questionTemplates', JSON.stringify(templates)); showModal('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… Ø­ÙØ¸ Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­.'); }
function getSavedQuestionTemplates() { return JSON.parse(localStorage.getItem('questionTemplates') || '[]'); }
function deleteSavedTemplate(event, index) { event.stopPropagation(); let templates = getSavedQuestionTemplates(); templates.splice(index, 1); localStorage.setItem('questionTemplates', JSON.stringify(templates)); modalContainer.style.display = 'none'; showQuestionTemplateModal(); }

// --- UTILITY ---
function escapeHtml(s) { if(!s) return ''; return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#x27;'}[c])); }
</script>
</body>
</html>
