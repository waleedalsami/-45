<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>الوليد للطباعة لتحرير الامتحانات</title>
<!-- PWA Tags -->
<meta name="theme-color" content="#2c3e50">
<link rel="manifest" href=""> <!-- Href will be set by JavaScript -->
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2YwZjRmNyIvPjxwYXRoIGQ9Ik0yNSw3NSBMMjAsODAgTDIwLDg1IEwyNSw4NSBMNzUsMzUgTDY1LDI1IFoiIGZpbGw9IiNEMzU0MDAiLz48cGF0aCBkPSJNNzAsMjAgTDgwLDMwIEw0MCw3MCBMMzAsNjAgWiIgZmlsbD0iIzJDM0U1MCIvPjxyZWN0IHg9IjI1IiB5PSI4MCIgd2lkdGg9IjUiIGhlaWdodD0iNSIgZmlsbD0iIzJDM0U1MCIvPjwvc3ZnPg==">


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;600;800&family=Lalezar&family=Noto+Naskh+Arabic:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root {
  /* Light Theme (Default) */
  --primary: #2c3e50; --accent: #d35400; --bg: #f0f4f7; --card: #ffffff;
  --text-primary: #212529; --text-muted: #7f8c8d; --border-color: #dce4ec;
  --border-color-strong: #34495e; --page-shadow: 0 10px 40px rgba(44, 62, 80, 0.2);
  --toolbar-bg: #ffffff; --input-bg: #ffffff; --hover-bg: #f1f5f9;
  --table-header-bg: #f3f3f3; --warning-bg: #fcf8e3; --warning-text: #8a6d3b;
  --font-main: "Cairo", sans-serif; --font-formal: "Amiri", serif; --toolbar-height: 55px;
}
html[data-theme="dark"] {
  --primary: #526f8c; --accent: #e67e22; --bg: #1a202c; --card: #2d3748;
  --text-primary: #edf2f7; --text-muted: #a0aec0; --border-color: #4a5568;
  --border-color-strong: #9fb3c8; --page-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
  --toolbar-bg: #2d3748; --input-bg: #4a5568; --hover-bg: #4a5568;
  --table-header-bg: #374151; --warning-bg: #4a3f2d; --warning-text: #e6d3a0;
}
*{box-sizing:border-box}
html,body{ height:100%; margin:0; font-family:var(--font-main); background:var(--bg); color:var(--text-primary); direction:rtl; transition: background-color 0.3s ease, color 0.3s ease; }
.app {display:flex; flex-direction:column; height:100vh; overflow:hidden;}
.topbar, .login-box, .card, .toolbar, .editor-footer, .modal-box, .page { transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; }
.topbar {display:flex; justify-content:space-between; align-items:center; padding:10px 15px; background:var(--card); border-bottom:1px solid var(--border-color); box-shadow: 0 2px 10px rgba(0,0,0,0.05);}
.brand {font-weight:800; color:var(--primary); font-size:18px}
.top-actions {display:flex; gap:8px; align-items:center}
#theme-toggle-btn { font-size: 1.2rem; padding: 6px 10px; }
.screen {display:none; height:100%; overflow:hidden}
.screen.active {display:block}
.screen-with-topbar { height:calc(100% - 52px); }
.login-wrap {display:flex; align-items:center; justify-content:center; height:100%}
.login-box {background:var(--card); padding:28px; width:95%; max-width:420px; border-radius:12px; box-shadow: var(--page-shadow)}
.login-box h2 {margin-bottom:14px; color:var(--primary)}
.login-box input {width:100%; padding:10px 12px; margin-bottom:10px; border-radius:8px; border:1px solid var(--border-color); font-size:15px; background-color: var(--input-bg); color: var(--text-primary);}
.main-shell {padding:14px; height:100%; overflow:auto}
.grid {display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px}
.card {background:var(--card); padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); display:flex; flex-direction:column; gap:8px}
.editor-shell {display:flex; flex-direction:column; height:100%; position: relative;}
.toolbar { display: flex; flex-wrap: nowrap; gap: 10px; align-items: center; padding: 8px 12px; background: var(--toolbar-bg); border-bottom: 2px solid var(--border-color); overflow-x: auto; white-space: nowrap; position: sticky; top: 0; z-index: 1000; height: var(--toolbar-height); scrollbar-width: thin; scrollbar-color: var(--primary) #e0e6ef; }
#contextual-toolbar { top: var(--toolbar-height); z-index: 999; border-top: 1px solid var(--border-color); box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
.toolbar::-webkit-scrollbar { height: 8px; }
.toolbar::-webkit-scrollbar-track { background: #e0e6ef; border-radius: 4px;}
.toolbar::-webkit-scrollbar-thumb { background-color: var(--primary); border-radius: 4px; }
.controls-row { display: inline-flex; gap: 6px; align-items: center; padding-inline-end: 15px; border-inline-end: 1px solid var(--border-color); margin-inline-end: 10px; }
.controls-row:last-child { border-inline-end: none; }
.btn { background: var(--card); border:1px solid var(--border-color); padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600; color:var(--primary); transition: all 0.2s ease; font-size: 15px; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
.toolbar .btn { font-size: 16px; height: 40px; }
.btn:hover{background: var(--hover-bg); box-shadow:0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px);}
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
.btn svg { width: 18px; height: 18px; vertical-align: middle; }
.select {padding:8px 12px; border-radius:8px; border:1px solid var(--border-color); background:var(--input-bg); color: var(--text-primary); height: 40px;}
.color-input {width:40px; height:40px; padding:2px; border-radius:8px; border:1px solid var(--border-color); overflow:hidden; display:inline-block; background-color: var(--input-bg);}
.color-input input{width:100%; height:100%; border:0; padding:0; background:transparent}
.workspace { flex:1; overflow:auto; padding:20px; }
.editor-footer { display: flex; justify-content: space-between; align-items: center; padding: 5px 15px; background: var(--card); border-top: 1px solid var(--border-color); }
#overflow-warning { display: none; color: var(--warning-text); background-color: var(--warning-bg); padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
.zoom-controls, .pagination-controls { display: flex; align-items: center; gap: 10px; }
.zoom-controls input[type="range"] { width: 120px; }
.zoom-controls label { font-size: 14px; font-weight: 600; min-width: 45px; text-align: left; }
#page-indicator { font-weight: 600; font-size: 14px; min-width: 50px; text-align: center; }
.page { 
    background: var(--card); width: 21cm; min-height: 29.7cm; 
    position: relative; display: flex; flex-direction: column; 
    font-family: var(--font-formal); font-size: 28px;
    page-break-after: always; transform-origin: top center; 
    box-shadow: var(--page-shadow); 
    padding: 1cm;
    border: 2px solid var(--border-color-strong); 
    transition: transform 0.2s ease, margin-bottom 0.2s ease, background-color 0.3s ease, border-color 0.3s ease, border-style 0.3s ease, border-width 0.3s ease; 
    margin: 0 auto;
}
.page:not(:last-child) { margin-bottom: 20px; }
html[data-theme="dark"] .page { color: #333; }
.page.border-double { border: 8px double var(--border-color-strong); }
.page.border-dotted { border: 3px dotted var(--border-color-strong); }
.page.border-none { border: none; padding: calc(1cm + 2px); }
.page.border-dashed-thick { border: 4px dashed var(--border-color-strong); }
.page.border-double-color { border: 8px double var(--accent); }
.page.border-gradient { border: 8px solid transparent; border-image: linear-gradient(45deg, var(--primary), var(--accent)) 1; }
.continuation-header { padding: 8px; background-color: #f0f4f7; border-bottom: 1.5px solid #dce4ec; margin-bottom: 10px; text-align: center; font-size: 0.9em; }
.page .page-delete-btn { position: absolute; width: 24px; height: 24px; background: #e74c3c; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 16px; line-height: 24px; }
.page:hover .page-delete-btn { display: flex; top: -12px; left: -12px; }
.questions-table tr .row-actions { position: absolute; display: none; flex-direction: column; gap: 4px; top: 50%; left: -34px; transform: translateY(-50%); z-index: 10; }
.questions-table tr:hover .row-actions { display: flex; }
.row-actions button { width: 28px; height: 28px; background: #7f8c8d; color: white; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 16px; line-height: 24px; }
.row-actions .row-delete-btn { background: #e74c3c; }
.row-actions .row-save-template-btn { background: #2980b9; font-size: 14px; }
.exam-header-container { padding-bottom: 10px; border-bottom: 2px solid var(--border-color-strong); margin-bottom: 15px; }
.exam-header-top-row { display: flex; justify-content: space-between; align-items: stretch; gap: 10px; }
.header-box, .header-box-center { border: 1px solid var(--border-color-strong); border-radius: 4px; padding: 5px; }
.header-box { flex: 1 1 35%; text-align: center; line-height: 1.5; font-size: 0.8em; }
.header-box-center { flex: 1 1 25%; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; gap: 5px; }
.exam-title-main { text-align: center; font-weight: bold; font-size: 1.2em; padding: 2px; width: 100%; }
.logo-container { cursor: pointer; display: flex; align-items: center; justify-content: center; width: 100%; height: 80px; }
.logo-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
.logo-placeholder { width: 100%; height: 100%; background: #f0f2f5; border: 2px dashed #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #888; flex-direction: column; }
.exam-footer { border-top: 2px solid var(--border-color-strong); padding-top: 10px; margin-top: auto; text-align: center; font-weight: bold; font-size: 1em; }
.questions-table { width: 100%; border-collapse: collapse; position: relative; font-size: 1em; } /* Inherits from .page */
.questions-table th, .questions-table td { border: 1px solid var(--border-color-strong); padding: 10px; vertical-align: top; position: relative; line-height: 1.6; }
.questions-table th { font-weight: 700; background: var(--table-header-bg); }
.col-num { width: 6%; } .col-grade { width: 8%; }
.page-content-wrapper { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
.inserted-item {
    display: inline-block;
    border: 1px dashed #ccc;
    position: relative;
    user-select: none;
    touch-action: none;
    cursor: default;
    vertical-align: middle;
}
.inserted-item img, .inserted-item svg, .inserted-item table { width: 100%; height: 100%; display: block; pointer-events: none;}
html[data-theme="dark"] .inserted-item svg { filter: invert(1); }
.inserted-item table { border-collapse: collapse; }
.inserted-item table td { border: 1px solid black; padding: 5px; pointer-events: auto;}
.math-template { display: inline-block; vertical-align: middle; margin: 0 2px; }
.inserted-item.selected { outline: 2px dashed var(--accent); box-shadow: 0 0 0 4px rgba(211, 84, 0, 0.2); z-index: 100; }
.item-controls { position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none; }
.item-controls > * { pointer-events: auto; }
.resize-handle { position: absolute; width: 16px; height: 16px; background: var(--accent); border: 2px solid var(--card); border-radius: 50%; bottom: -8px; right: -8px; cursor: se-resize; }
.rotate-handle { position: absolute; width: 16px; height: 16px; background: var(--primary); border: 2px solid var(--card); border-radius: 50%; top: -8px; right: -8px; cursor: grab; }
.rotate-handle:active { cursor: grabbing; }
.delete-handle { position: absolute; width: 16px; height: 16px; background: #e74c3c; color: white; border: 2px solid var(--card); border-radius: 50%; top: -8px; left: -8px; cursor: pointer; font-size: 12px; line-height: 12px; text-align: center; font-weight: bold; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
.modal-box { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: var(--page-shadow); width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;}
.modal-box h3, .modal-box h4 { margin-top: 0; color: var(--primary); }
.modal-box .form-group { margin-bottom: 15px; }
.modal-box .form-group label { display: block; margin-bottom: 5px; }
.modal-box .form-group input, .modal-box .form-group select, .gemini-modal-content textarea { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--input-bg); color: var(--text-primary); }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
.border-options { display: flex; justify-content: space-around; gap: 10px; flex-wrap: wrap; }
.border-options .btn { flex-direction: column; height: auto; padding: 10px; }
.border-options .border-preview { width: 60px; height: 40px; border: 2px solid var(--text-primary); margin-bottom: 5px; }
.border-options .border-double { border-style: double; border-width: 4px; }
.border-options .border-dotted { border-style: dotted; }
.shape-grid, .math-grid, .symbol-grid, .template-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; }
.shape-item, .math-item, .symbol-item, .template-item { padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; display:flex; align-items:center; justify-content:center; flex-direction:column; text-align:center; }
.shape-item:hover, .math-item:hover, .symbol-item:hover, .template-item:hover { background: var(--hover-bg); border-color: var(--primary); }
.shape-item svg { width: 100%; height: 40px; }
.math-item { font-family: var(--font-formal); font-size: 1.1em; min-height: 60px; line-height: 1.2; }
.math-item small, .shape-item small { font-size: 0.7em; font-family: var(--font-main); color: var(--text-muted); margin-top: 5px; }
.symbol-item { font-size: 1.8em; }
.template-list { grid-template-columns: 1fr; }
.template-item { flex-direction: row; justify-content: space-between; align-items: center; }
.template-item .template-content { flex: 1; text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.template-item button { background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; }
.gemini-modal-content textarea { min-height: 150px; margin-top: 10px; font-size: 15px; resize: vertical; }
.loader { border: 4px solid var(--hover-bg); border-radius: 50%; border-top: 4px solid var(--primary); width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@media print { html, body, .app, .workspace { background: #fff !important; color: #000 !important; } .topbar, .toolbar, .editor-footer, .page-delete-btn, .row-actions, .item-controls, #add-page-overflow-btn { display: none !important; } .workspace { padding: 0; overflow-y: visible !important; } .page { transform: scale(1) !important; box-shadow: none !important; margin: 0 !important; border-color: #34495e !important; background-color: #fff !important; color: #000 !important; } .page.border-double { border: 8px double #34495e !important; } .page.border-dotted { border: 3px dotted #34495e !important; } .page.border-none { border: none !important; } .inserted-item.selected { outline: none; box-shadow: none; } .inserted-item { border-color: transparent; } .header-box, .exam-title-main { border: 1px solid #34495e !important; } .questions-table th, .questions-table td { border: 1px solid #34495e !important; } .questions-table th { background-color: #f3f3f3 !important; } }
.hidden{display:none}
</style>
</head>
<body>

<div class="app">
  <div class="topbar">
    <div class="brand">الوليد للطباعة لتحرير الامتحانات</div>
    <div class="top-actions">
      <button id="theme-toggle-btn" class="btn" title="تبديل المظهر">🌙</button>
      <span id="user-display" class="small"></span>
      <button id="logout-btn" class="btn small hidden">خروج</button>
    </div>
  </div>

  <div id="login-screen" class="screen screen-with-topbar active">
    <div class="login-wrap"><div class="login-box"><h2>تسجيل الدخول</h2><input id="teacher-name" placeholder="اسم المدرس/ة" /><input id="school-name" placeholder="اسم المدرسة" /><div style="display:flex; gap:8px; margin-top:6px"><button id="login-btn" class="btn" style="flex:1">الدخول</button></div></div></div>
  </div>

  <div id="main-screen" class="screen screen-with-topbar">
    <div class="main-shell"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px"><h3>الاختبارات المحفوظة</h3><div><button id="new-exam-btn" class="btn">اختبار فارغ</button></div></div><div id="exam-grid" class="grid"></div></div>
  </div>

  <div id="editor-screen" class="screen">
    <div class="editor-shell">
      <div class="toolbar">
        <div class="controls-row">
          <button class="btn" data-cmd="undo" title="تراجع">↶</button>
          <button class="btn" data-cmd="redo" title="إعادة">↷</button>
          <button class="btn" id="save-exam" title="حفظ">💾</button>
          <button class="btn" id="print-btn" title="طباعة">🖨️</button>
          <button class="btn" id="export-pdf" title="تصدير PDF">📄</button>
          <button class="btn" id="back-to-main-btn" title="الرجوع">رجوع</button>
        </div>
        <div class="controls-row">
            <button class="btn" id="add-question-btn" title="إضافة سؤال">➕ سؤال</button>
            <button class="btn" id="delete-question-btn" title="حذف السؤال المحدد">🗑️ حذف</button>
            <button class="btn" id="add-page-btn" title="إضافة صفحة">➕ صفحة</button>
            <button class="btn" id="shuffle-questions-btn" title="خلط ترتيب الأسئلة لعمل نموذج آخر">🔀</button>
            <button class="btn" id="insert-question-template-btn" title="إدراج قالب سؤال">📋 قالب</button>
            <button class="btn" id="save-selection-btn" title="حفظ النص المحدد كقالب" disabled>💾 نص</button>
        </div>
        <div class="controls-row">
            <button class="btn" id="insert-image" title="إدراج صورة">🖼️</button>
            <button class="btn" id="insert-table" title="إدراج جدول">▦</button>
            <button class="btn" id="insert-shape" title="إدراج شكل">🎨</button>
            <button class="btn" id="insert-symbol-btn" title="إدراج رمز">Ω</button>
            <button class="btn" id="rotate-item-btn" title="تدوير الشكل المحدد" disabled>↪️</button>
            <button class="btn" id="change-border-btn" title="تغيير إطار الصفحة">🖼️ إطار</button>
        </div>
        <div class="controls-row">
          <button class="btn" data-cmd="bold"><b>ع</b></button>
          <button class="btn" data-cmd="italic"><i>م</i></button>
          <button class="btn" data-cmd="underline"><u>ت</u></button>
          <button class="btn" data-cmd="superscript" title="نص علوي">x²</button>
          <button class="btn" data-cmd="subscript" title="نص سفلي">x₂</button>
          <select id="font-name" class="select">
            <option style="font-family: 'Amiri';" value="Amiri">Amiri</option>
            <option style="font-family: 'Cairo';" value="Cairo">Cairo</option>
            <option style="font-family: 'Tajawal';" value="Tajawal">Tajawal</option>
            <option style="font-family: 'Lalezar';" value="Lalezar">Lalezar</option>
            <option style="font-family: 'Noto Naskh Arabic';" value="Noto Naskh Arabic">Noto Naskh</option>
            <option style="font-family: 'Arial';" value="Arial">Arial</option>
          </select>
          <button class="btn" id="decrease-size" title="تصغير النص">-</button>
          <button class="btn" id="increase-size" title="تكبير النص">+</button>
          <div class="color-input"><input id="font-color" type="color" title="لون الخط"></div>
        </div>
        <div class="controls-row">
            <button class="btn" data-cmd="justifyRight" title="محاذاة لليمين">☵</button>
            <button class="btn" data-cmd="justifyCenter" title="توسيط">☲</button>
            <button class="btn" data-cmd="justifyLeft" title="محاذاة لليسار">☴</button>
            <button class="btn" id="decrease-line-height" title="تقليل تباعد الأسطر">▼</button>
            <button class="btn" id="increase-line-height" title="زيادة تباعد الأسطر">▲</button>
            <button class="btn" data-vertical-align="top" title="محاذاة للأعلى">⤒</button>
            <button class="btn" data-vertical-align="middle" title="محاذاة للوسط">⇹</button>
            <button class="btn" data-vertical-align="bottom" title="محاذاة للأسفل">⤓</button>
        </div>
         <div class="controls-row">
            <button class="btn" data-orientation="horizontal-tb" title="اتجاه أفقي">↔</button>
            <button class="btn" data-orientation="vertical-rl" title="عمودي (لليمين)">↓→</button>
            <button class="btn" data-orientation="vertical-lr" title="عمودي (لليسار)">↓←</button>
            <button class="btn" id="toggle-rotate-text" title="قلب النص رأسًا على عقب">🔄</button>
        </div>
        <div class="controls-row">
          <button class="btn" id="insert-fraction" title="كسر">÷</button>
          <button class="btn" id="insert-sqrt" title="جذر تربيعي">√</button>
          <button class="btn" id="insert-power" title="أس">xʸ</button>
          <button class="btn" id="insert-more-math" title="إدراج معادلات">∫</button>
        </div>
      </div>
      <!-- New Contextual Toolbar -->
      <div id="contextual-toolbar" class="toolbar" style="display: none;"></div>
      <div id="workspace" class="workspace"></div>
      
      <div class="editor-footer">
        <span id="overflow-warning">تحذير: تجاوز في محتوى الصفحة</span>
        <div class="zoom-controls">
            <label id="zoom-label">60%</label>
            <input type="range" id="zoom-slider" min="20" max="150" value="60">
        </div>
        <div class="pagination-controls">
            <button id="prev-page-btn" class="btn" title="الصفحة السابقة">◀</button>
            <span id="page-indicator">1 / 1</span>
            <button id="next-page-btn" class="btn" title="الصفحة التالية">▶</button>
        </div>
        <span id="save-status">جاهز</span>
      </div>
    </div>
  </div>
</div>
<input type="file" id="logo-input" accept="image/*" class="hidden">
<input type="file" id="image-input" accept="image/*" class="hidden">
<div id="modal-container" class="modal-overlay"></div>

<script>
// --- STATE & SETUP ---
let currentUser = null, currentExamId = null, focusedEditable = null, activeItem = null, savedSelection = null;
let historyDebounceTimer, autoSaveInterval;
let currentPageIndex = 0;
let pageObserver;

const workspace = document.getElementById('workspace');
const modalContainer = document.getElementById('modal-container');
const zoomSlider = document.getElementById('zoom-slider');
const zoomLabel = document.getElementById('zoom-label');
const themeToggleBtn = document.getElementById('theme-toggle-btn');
const overflowWarning = document.getElementById('overflow-warning');
const contextualToolbar = document.getElementById('contextual-toolbar');


document.addEventListener('DOMContentLoaded', initApp);

function initApp() {
    setupPWA();
    setupEventListeners();
    applyInitialTheme();
    setupPageObserver();
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        document.getElementById('user-display').textContent = `${currentUser.teacher} — ${currentUser.school}`;
        document.getElementById('logout-btn').classList.remove('hidden');
        showScreen('main-screen');
        renderExamGrid();
    } else {
        showScreen('login-screen');
    }
    updatePageZoom();
    updatePaginationUI();
}

function setupEventListeners() {
    themeToggleBtn.addEventListener('click', toggleTheme);
    document.getElementById('login-btn').addEventListener('click', handleLogin);
    document.getElementById('new-exam-btn').addEventListener('click', () => newExam());
    document.getElementById('logout-btn').addEventListener('click', logout);
    document.getElementById('back-to-main-btn').addEventListener('click', () => { showScreen('main-screen'); renderExamGrid(); });
    document.getElementById('save-exam').addEventListener('click', () => saveExam(true));
    document.getElementById('print-btn').addEventListener('click', () => window.print());
    document.getElementById('export-pdf').addEventListener('click', exportPDF);
    document.getElementById('add-question-btn').addEventListener('click', () => addQuestionToTable());
    document.getElementById('delete-question-btn').addEventListener('click', deleteCurrentQuestion);
    document.getElementById('add-page-btn').addEventListener('click', addContinuationPage);
    document.getElementById('shuffle-questions-btn').addEventListener('click', shuffleQuestions);
    document.getElementById('save-selection-btn').addEventListener('click', saveSelectionAsTemplate);
    document.getElementById('insert-image').addEventListener('click', () => document.getElementById('image-input').click());
    document.getElementById('insert-table').addEventListener('click', showTableModal);
    document.getElementById('insert-shape').addEventListener('click', showShapeModal);
    document.querySelectorAll('[data-cmd]').forEach(b => b.addEventListener('click', () => execCmd(b.dataset.cmd, b.dataset.value || null)));
    document.getElementById('font-name').addEventListener('change', (e) => { restoreSelection(); execCmd('fontName', e.target.value); });
    document.getElementById('font-color').addEventListener('input', (e) => { execCmd('foreColor', e.target.value); });
    document.getElementById('increase-size').addEventListener('click', () => changeSelectedFontSize(2));
    document.getElementById('decrease-size').addEventListener('click', () => changeSelectedFontSize(-2));
    document.getElementById('increase-line-height').addEventListener('click', () => changeLineHeight(0.1));
    document.getElementById('decrease-line-height').addEventListener('click', () => changeLineHeight(-0.1));
    document.querySelectorAll('[data-orientation]').forEach(b => b.addEventListener('click', () => setTextOrientation(b.dataset.orientation)));
    document.getElementById('toggle-rotate-text').addEventListener('click', toggleTextRotation);
    document.querySelectorAll('[data-vertical-align]').forEach(b => b.addEventListener('click', (e) => setVerticalAlign(e.currentTarget.dataset.verticalAlign)));
    document.getElementById('rotate-item-btn').addEventListener('click', rotateActiveItem);
    document.getElementById('insert-symbol-btn').addEventListener('click', showSymbolModal);
    document.getElementById('insert-question-template-btn').addEventListener('click', showQuestionTemplateModal);
    document.querySelectorAll('.toolbar .btn, .toolbar .select, .toolbar .color-input').forEach(el => {
        el.addEventListener('mousedown', e => { saveSelection(); if(el.tagName !== 'SELECT') e.preventDefault(); });
    });
    
    document.addEventListener('selectionchange', () => {
        const sel = window.getSelection();
        document.getElementById('save-selection-btn').disabled = sel.isCollapsed;
    });

    workspace.addEventListener('focusin', e => { 
        if (e.target.isContentEditable) focusedEditable = e.target;
    });
    workspace.addEventListener('click', handleWorkspaceClick);
    workspace.addEventListener('input', () => { clearTimeout(historyDebounceTimer); historyDebounceTimer = setTimeout(saveExam, 2000); });
    workspace.addEventListener('scroll', () => {
        let closestPage = 0; let minDistance = Infinity;
        const pages = workspace.querySelectorAll('.page');
        const containerMidpoint = workspace.getBoundingClientRect().top + workspace.clientHeight / 2;
        pages.forEach((page, index) => {
            const pageMidpoint = page.getBoundingClientRect().top + page.clientHeight / 2;
            const distance = Math.abs(containerMidpoint - pageMidpoint);
            if (distance < minDistance) { minDistance = distance; closestPage = index; }
        });
        if (closestPage !== currentPageIndex) { currentPageIndex = closestPage; updatePaginationUI(); }
    });
    document.getElementById('logo-input').addEventListener('change', e => handleImageUpload(e, '.logo-container img', true));
    document.getElementById('image-input').addEventListener('change', e => handleImageUpload(e, null, false));
    zoomSlider.addEventListener('input', updatePageZoom);
    document.getElementById('change-border-btn').addEventListener('click', showBorderModal);
    document.getElementById('insert-fraction').addEventListener('click', insertFraction);
    document.getElementById('insert-sqrt').addEventListener('click', insertSqrt);
    document.getElementById('insert-power').addEventListener('click', insertPowerTemplate);
    document.getElementById('insert-more-math').addEventListener('click', showMathEquationsModal);
    document.getElementById('prev-page-btn').addEventListener('click', () => goToPage(currentPageIndex - 1));
    document.getElementById('next-page-btn').addEventListener('click', () => goToPage(currentPageIndex + 1));
}

function setupPWA() {
    const manifest = {
      name: "الوليد للطباعة لتحرير الامتحانات",
      short_name: "محرر الامتحانات",
      start_url: ".",
      display: "standalone",
      background_color: "#f0f4f7",
      theme_color: "#2c3e50",
      description: "تطبيق ويب لتحرير وتصميم الاختبارات المدرسية.",
      icons: [{
        src: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2YwZjRmNyIvPjxwYXRoIGQ9Ik0yNSw3NSBMMjAsODAgTDIwLDg1IEwyNSw4NSBMNzUsMzUgTDY1LDI1IFoiIGZpbGw9IiNEMzU0MDAiLz48cGF0aCBkPSJNNzAsMjAgTDgwLDMwIEw0MCw3MCBMMzAsNjAgWiIgZmlsbD0iIzJDM0U1MCIvPjxyZWN0IHg9IjI1IiB5PSI4MCIgd2lkdGg9IjUiIGhlaWdodD0iNSIgZmlsbD0iIzJDM0U1MCIvPjwvc3ZnPg==",
        sizes: "192x192", type: "image/svg+xml"
      },{
        src: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2YwZjRmNyIvPjxwYXRoIGQ9Ik0yNSw3NSBMMjAsODAgTDIwLDg1IEwyNSw4NSBMNzUsMzUgTDY1LDI1IFoiIGZpbGw9IiNEMzU0MDAiLz48cGF0aCBkPSJNNzAsMjAgTDgwLDMwIEw0MCw3MCBMMzAsNjAgWiIgZmlsbD0iIzJDM0U1MCIvPjxyZWN0IHg9IjI1IiB5PSI4MCIgd2lkdGg9IjUiIGhlaWdodD0iNSIgZmlsbD0iIzJDM0U1MCIvPjwvc3ZnPg==",
        sizes: "512x512", type: "image/svg+xml"
      }]
    };
    const manifestString = JSON.stringify(manifest);
    const manifestBlob = new Blob([manifestString], {type: 'application/json'});
    const manifestUrl = URL.createObjectURL(manifestBlob);
    document.querySelector('link[rel="manifest"]').setAttribute('href', manifestUrl);
    
    if ('serviceWorker' in navigator) {
        const swContent = `
            const CACHE_NAME = 'exam-editor-cache-v1';
            const urlsToCache = ['.', 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js', 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'];
            self.addEventListener('install', event => { event.waitUntil( caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)) ); });
            self.addEventListener('fetch', event => { event.respondWith( caches.match(event.request).then(response => response || fetch(event.request)) ); });
        `;
        const swBlob = new Blob([swContent], {type: 'application/javascript'});
        const swUrl = URL.createObjectURL(swBlob);
        
        window.addEventListener('load', () => {
            navigator.serviceWorker.register(swUrl)
                .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
                .catch(err => console.log('ServiceWorker registration failed: ', err));
        });
    }
}


function applyInitialTheme() { const savedTheme = localStorage.getItem('theme') || 'light'; document.documentElement.setAttribute('data-theme', savedTheme); themeToggleBtn.innerHTML = savedTheme === 'dark' ? '☀️' : '🌙'; themeToggleBtn.title = savedTheme === 'dark' ? 'التحويل للمظهر الفاتح' : 'التحويل للمظهر الداكن'; }
function toggleTheme() { const currentTheme = document.documentElement.getAttribute('data-theme'); const newTheme = currentTheme === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', newTheme); localStorage.setItem('theme', newTheme); themeToggleBtn.innerHTML = newTheme === 'dark' ? '☀️' : '🌙'; themeToggleBtn.title = newTheme === 'dark' ? 'التحويل للمظهر الفاتح' : 'التحويل للمظهر الداكن'; }
function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); const topbar = document.querySelector('.topbar'); if (id === 'editor-screen') { topbar.style.display = 'none'; } else { topbar.style.display = 'flex'; } if(id !== 'editor-screen' && autoSaveInterval) { clearInterval(autoSaveInterval); } }
function handleLogin() { const teacher = document.getElementById('teacher-name').value.trim(); const school = document.getElementById('school-name').value.trim(); if (!teacher || !school) { return; } currentUser = { teacher, school }; localStorage.setItem('currentUser', JSON.stringify(currentUser)); document.getElementById('user-display').textContent = `${teacher} — ${school}`; document.getElementById('logout-btn').classList.remove('hidden'); showScreen('main-screen'); renderExamGrid(); }
function logout() { localStorage.removeItem('currentUser'); currentUser = null; showScreen('login-screen'); document.getElementById('logout-btn').classList.add('hidden'); }
function renderExamGrid() { const grid = document.getElementById('exam-grid'); grid.innerHTML = ''; const keys = Object.keys(localStorage).filter(k => k.startsWith('exam_')); keys.forEach(k => { const ex = JSON.parse(localStorage.getItem(k)); const card = document.createElement('div'); card.className = 'card'; card.innerHTML = `<h3>${escapeHtml(ex.title || 'بلا عنوان')}</h3><div class="row small"><span>${new Date(ex.lastModified).toLocaleString()}</span></div><div style="margin-top:8px; display:flex; gap:8px"><button class="btn" onclick="openExam('${ex.id}')">فتح</button><button class="btn" style="background: #e74c3c; color:white" onclick="deleteExam('${ex.id}')">حذف</button></div>`; grid.appendChild(card); }); }
function newExam(templateHTML = '') { currentExamId = 'exam_' + Date.now(); const content = templateHTML || createNewPageHTML(); const newExamData = { id: currentExamId, title: 'اختبار جديد', lastModified: new Date().toISOString(), content }; localStorage.setItem(currentExamId, JSON.stringify(newExamData)); openEditorWithContent(content); showScreen('editor-screen'); }
function openExam(id) { const ex = JSON.parse(localStorage.getItem(id)); if (!ex) return; currentExamId = id; openEditorWithContent(ex.content); showScreen('editor-screen'); }
function deleteExam(id) { showModal('تأكيد الحذف', '<p>هل أنت متأكد من رغبتك في حذف هذا الاختبار نهائياً؟ لا يمكن التراجع عن هذا الإجراء.</p>', (confirmed) => { if (confirmed) { localStorage.removeItem(id); renderExamGrid(); } }); }

function openEditorWithContent(html) {
    workspace.innerHTML = (!html || html.trim() === '') ? createNewPageHTML() : html;
    initializeRowActions(); // Add actions buttons to loaded content
    if(autoSaveInterval) clearInterval(autoSaveInterval);
    autoSaveInterval = setInterval(saveExam, 30000);
    setTimeout(() => { goToPage(0); checkAllPagesForOverflow(); }, 100);
}

function saveExam(isManual = false) {
    if (activeItem) deselectItem();
    if (!currentExamId) return;

    // Clone workspace to remove UI elements before saving
    const workspaceClone = workspace.cloneNode(true);
    workspaceClone.querySelectorAll('.row-actions, .item-controls').forEach(el => el.remove());
    workspaceClone.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
    const cleanContent = workspaceClone.innerHTML;

    const firstTitle = workspace.querySelector('.exam-title-main')?.textContent.trim() || 'اختبار';
    const payload = { id: currentExamId, title: firstTitle, lastModified: new Date().toISOString(), content: cleanContent };
    localStorage.setItem(currentExamId, JSON.stringify(payload));
    document.getElementById('save-status').textContent = `تم الحفظ ${new Date().toLocaleTimeString()}`;
    if(isManual) showModal('تم الحفظ', '<p>تم حفظ التغييرات بنجاح.</p>');
}


// --- PAGE & CONTENT CREATION ---
function createNewPageHTML() { return `<div class="page"><div class="page-delete-btn" title="حذف الصفحة">&times;</div><header class="exam-header-container"><div class="exam-header-top-row"><div class="header-box" contenteditable="true">الجمهورية اليمنية<br>وزارة التربية والتعليم<br>مكتب التربيه والتعليم م/تعز<br>ادارة التربية والتعليم م/خدير<br>مدرسة / .................</div><div class="header-box-center"><div class="logo-container"><div class="logo-placeholder"><span>انقر لإضافة</span><span>شعار</span></div><img src="" alt="" style="display:none;"></div><div class="exam-title-main" contenteditable="true">عنوان الاختبار</div></div><div class="header-box" contenteditable="true">اسم الطالب: .......................<br>الصف: ............................<br>المادة: ............................<br>الشعبة: ...........................<br>التاريخ: ...../...../...........</div></div></header><div class="page-content-wrapper"><table class="questions-table"><thead><tr><th class="col-num" contenteditable="true">ت</th><th class="col-question" contenteditable="true">الســــــــــــــــــــــــــــؤال</th><th class="col-grade" contenteditable="true">الدرجة</th></tr></thead><tbody></tbody></table></div><footer class="exam-footer" contenteditable="true">مع تمنياتنا لكم بالنجاح والتوفيق</footer></div>`; }
function createNewContinuationPageHTML() { const pageNumber = workspace.querySelectorAll('.page').length + 1; return `<div class="page"><div class="page-delete-btn" title="حذف الصفحة">&times;</div><header class="continuation-header" contenteditable="true">تابع اختبار ...</header><div class="page-content-wrapper"><table class="questions-table"><thead><tr><th class="col-num" contenteditable="true">ت</th><th class="col-question" contenteditable="true">الســــــــــــــــــــــــــــؤال</th><th class="col-grade" contenteditable="true">الدرجة</th></tr></thead><tbody></tbody></table></div><footer class="exam-footer" contenteditable="true">صفحة (${pageNumber})</footer></div>`; }
function addContinuationPage() { const newPageHTML = createNewContinuationPageHTML(); workspace.insertAdjacentHTML('beforeend', newPageHTML); updatePageZoom(); const newPageIndex = workspace.querySelectorAll('.page').length - 1; goToPage(newPageIndex); return workspace.querySelector('.page:last-of-type'); }

// --- OVERFLOW CHECK & QUESTION MANAGEMENT ---
function setupPageObserver() { pageObserver = new MutationObserver(() => checkAllPagesForOverflow()); pageObserver.observe(workspace, { childList: true, subtree: true, characterData: true, attributes: true }); }
function isPageOverflowing(page) {
    if (!page) return false;
    const footer = page.querySelector('.exam-footer');
    const lastRow = page.querySelector('.questions-table tbody tr:last-child');
    if (!footer || !lastRow) { return page.scrollHeight > page.clientHeight + 1; }
    const footerTop = footer.getBoundingClientRect().top;
    const lastRowBottom = lastRow.getBoundingClientRect().bottom;
    return lastRowBottom > footerTop - 20; // 20px safety margin
}
function checkAllPagesForOverflow() { let isAnyPageOverflowing = false; workspace.querySelectorAll('.page').forEach(page => { if (isPageOverflowing(page)) isAnyPageOverflowing = true; }); overflowWarning.style.display = isAnyPageOverflowing ? 'inline' : 'none'; }
function placeCursorAtEnd(el) { el.focus(); const range = document.createRange(); range.selectNodeContents(el); range.collapse(false); const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range); }
function addQuestionToTable(content = '', targetPage = null) { 
    let page = targetPage || workspace.querySelector('.page:last-of-type');
    if (!page) { page = addContinuationPage(); }
    
    if (isPageOverflowing(page)) {
        showModal('تنبيه: الصفحة ممتلئة', '<p>لا يمكن إضافة المزيد من الأسئلة لهذه الصفحة. يجب إضافة صفحة جديدة أولاً.</p><p>اضغط "موافق" لإضافة صفحة جديدة وإدراج السؤال فيها.</p>', (confirmed) => { 
            if (confirmed) { const newPage = addContinuationPage(); addQuestionToTable(content, newPage); }
        });
        return;
    }

    let tbody = page.querySelector('.questions-table tbody');
    if(!tbody) return;
    const tr = document.createElement('tr');
    const rowCount = workspace.querySelectorAll('.questions-table tbody tr').length + 1;
    tr.innerHTML = `<td contenteditable="true" style="text-align: center;">${rowCount}</td><td class="q-text" contenteditable="true">${content}</td><td contenteditable="true" style="text-align: center;"></td>`;
    appendRowActions(tr); // Add actions to the new row
    tbody.appendChild(tr);
    const newCell = tr.querySelector('.q-text');
    if (newCell) setTimeout(() => placeCursorAtEnd(newCell), 50);
}
function deleteCurrentQuestion() { if (!focusedEditable) { showModal('خطأ', 'الرجاء تحديد سؤال لحذفه أولاً.'); return; } const questionRow = focusedEditable.closest('tr'); if (questionRow && questionRow.parentElement?.tagName === 'TBODY') { questionRow.remove(); } else { showModal('خطأ', 'لم يتم العثور على سؤال صالح للحذف في المكان المحدد.'); } }
function appendRowActions(row) { const actionsDiv = document.createElement('div'); actionsDiv.className = 'row-actions'; actionsDiv.innerHTML = `<button class="row-delete-btn" title="حذف السؤال">&times;</button><button class="row-save-template-btn" title="حفظ كقالب">💾</button>`; row.appendChild(actionsDiv); }
function initializeRowActions() { workspace.querySelectorAll('.questions-table tbody tr').forEach(row => { if (!row.querySelector('.row-actions')) { appendRowActions(row); } }); }


// --- UI & NAVIGATION ---
function goToPage(index) { const pages = workspace.querySelectorAll('.page'); if (index >= 0 && index < pages.length) { pages[index].scrollIntoView({ behavior: 'smooth', block: 'center' }); currentPageIndex = index; updatePaginationUI(); } }
function updatePaginationUI() { const pages = workspace.querySelectorAll('.page'); const pageCount = pages.length; document.getElementById('page-indicator').textContent = `${currentPageIndex + 1} / ${pageCount}`; document.getElementById('prev-page-btn').disabled = (currentPageIndex === 0); document.getElementById('next-page-btn').disabled = (currentPageIndex >= pageCount - 1); }
function updatePageZoom() { const zoomValue = zoomSlider.value; zoomLabel.textContent = `${zoomValue}%`; const scale = zoomValue / 100; const pages = workspace.querySelectorAll('.page'); pages.forEach(page => { page.style.transform = `scale(${scale})`; }); workspace.style.overflowX = zoomValue > 45 ? 'auto' : 'hidden'; }

// --- SELECTION HANDLING ---
function saveSelection() { if (window.getSelection) { const sel = window.getSelection(); if (sel.getRangeAt && sel.rangeCount) savedSelection = sel.getRangeAt(0); } else if (document.selection?.createRange) savedSelection = document.selection.createRange(); else savedSelection = null; }
function restoreSelection() { if (savedSelection) { if (window.getSelection) { const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(savedSelection); } else if (document.selection?.select) savedSelection.select(); } }

// --- TEXT FORMATTING ---
function execCmd(cmd, value = null) { document.execCommand(cmd, false, value); if(focusedEditable) focusedEditable.focus(); }
function changeSelectedFontSize(delta) { restoreSelection(); const selection = window.getSelection(); if (!selection.rangeCount) return; const range = selection.getRangeAt(0); let parentElement = range.commonAncestorContainer; if (parentElement.nodeType !== Node.ELEMENT_NODE) parentElement = parentElement.parentElement; const currentSize = parseFloat(window.getComputedStyle(parentElement).fontSize); const newSize = Math.max(8, currentSize + delta); document.execCommand('fontSize', false, '1'); const fontElements = (focusedEditable || workspace).querySelectorAll('font[size="1"]'); fontElements.forEach(el => { el.removeAttribute('size'); el.style.fontSize = `${newSize}px`; }); }
function setVerticalAlign(align) { if (!focusedEditable) return; const cell = focusedEditable.closest('td'); if (cell) cell.style.verticalAlign = align; }
function changeLineHeight(delta) { if (!focusedEditable) return; const blockElement = focusedEditable.closest('td, div, p'); if (blockElement) { const currentLineHeight = parseFloat(blockElement.style.lineHeight) || 1.6; const newLineHeight = Math.max(1.0, currentLineHeight + delta); blockElement.style.lineHeight = newLineHeight.toFixed(2); } }
function setTextOrientation(orientation) { if (!focusedEditable) return; const blockElement = focusedEditable.closest('td, div, p'); if (blockElement) { blockElement.style.writingMode = orientation; } }
function toggleTextRotation() { if (!focusedEditable) return; const blockElement = focusedEditable.closest('td, div, p'); if (blockElement) { const currentTransform = blockElement.style.transform; if (currentTransform.includes('rotate(180deg)')) { blockElement.style.transform = ''; } else { blockElement.style.transform = 'rotate(180deg)'; } } }

// --- TEMPLATES & SHUFFLE ---
function saveSelectionAsTemplate() {
    restoreSelection();
    const sel = window.getSelection();
    if (sel.isCollapsed) return;
    const range = sel.getRangeAt(0);
    const content = range.cloneContents();
    const tempDiv = document.createElement('div');
    tempDiv.appendChild(content);
    saveQuestionTemplate(tempDiv.innerHTML);
}
function shuffleQuestions() {
    showModal('تأكيد خلط الأسئلة', '<p>هل أنت متأكد من رغبتك في إعادة ترتيب كل الأسئلة بشكل عشوائي؟ سيتم إنشاء نموذج جديد للاختبار. لا يمكن التراجع عن هذا الإجراء مباشرة.</p>', (confirmed) => {
        if (confirmed) {
            const allRows = Array.from(workspace.querySelectorAll('.questions-table tbody tr'));
            const shuffledRows = allRows.sort(() => Math.random() - 0.5);
            workspace.querySelectorAll('.questions-table tbody').forEach(tbody => tbody.innerHTML = '');
            let currentPageIndex = 0; let pages = workspace.querySelectorAll('.page');
            shuffledRows.forEach((row, index) => {
                let currentPage = pages[currentPageIndex];
                if (isPageOverflowing(currentPage)) {
                    currentPageIndex++;
                    if (currentPageIndex >= pages.length) {
                        addContinuationPage();
                        pages = workspace.querySelectorAll('.page');
                    }
                    currentPage = pages[currentPageIndex];
                }
                const tbody = currentPage.querySelector('.questions-table tbody');
                row.cells[0].textContent = index + 1;
                tbody.appendChild(row);
            });
            checkAllPagesForOverflow();
        }
    });
}

// --- PDF EXPORT ---
async function exportPDF() { if (activeItem) deselectItem(); document.getElementById('save-status').textContent = 'جاري تحضير ملف PDF...'; modalContainer.innerHTML = `<div class="modal-box"><h3>جاري التصدير...</h3><p>الرجاء الانتظار، يتم إنشاء ملف PDF عالي الجودة.</p><div class="loader" style="display: block;"></div></div>`; modalContainer.style.display = 'flex'; try { const { jsPDF } = window.jspdf; const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4', putOnlyUsedFonts: true }); const originalPages = Array.from(workspace.querySelectorAll('.page')); const printContainer = document.createElement('div'); printContainer.style.position = 'absolute'; printContainer.style.left = '-9999px'; printContainer.style.top = '0'; document.body.appendChild(printContainer); for(let i = 0; i < originalPages.length; i++) { const originalPage = originalPages[i]; const clonedPage = originalPage.cloneNode(true); clonedPage.style.transform = 'scale(1)'; clonedPage.style.boxShadow = 'none'; clonedPage.style.margin = '0'; clonedPage.style.backgroundColor = '#ffffff'; clonedPage.style.color = '#000000'; clonedPage.querySelectorAll('*').forEach(el => { el.style.color = '#000000'; }); clonedPage.querySelectorAll('.row-actions, .item-controls').forEach(el => el.remove()); clonedPage.querySelectorAll('.questions-table th').forEach(th => { th.style.backgroundColor = '#f3f3f3'; }); printContainer.appendChild(clonedPage); if(i > 0) pdf.addPage(); const canvas = await html2canvas(clonedPage, { scale: 3, useCORS: true, logging: false, width: clonedPage.offsetWidth, height: clonedPage.offsetHeight, }); pdf.addImage(canvas.toDataURL('image/png', 1.0), 'PNG', 0, 0, 210, 297, undefined, 'FAST'); printContainer.removeChild(clonedPage); } document.body.removeChild(printContainer); const title = workspace.querySelector('.exam-title-main')?.textContent.trim() || 'exam'; pdf.save(`${title}.pdf`); document.getElementById('save-status').textContent = 'تم تصدير الملف بنجاح!'; } catch (error) { console.error("PDF Export Error:", error); document.getElementById('save-status').textContent = 'حدث خطأ أثناء التصدير.'; showModal('خطأ', 'عذراً, حدث خطأ أثناء إنشاء ملف PDF. الرجاء المحاولة مرة أخرى.'); } finally { modalContainer.style.display = 'none'; } }

// --- INSERTIONS (IMAGES, MATH, ETC.) ---
function insertNodeAtCaret(node) { 
    if (!focusedEditable) return; 
    focusedEditable.focus(); 
    restoreSelection(); 
    const sel = window.getSelection(); 
    if (!sel.rangeCount) return; 
    const range = sel.getRangeAt(0); 
    range.deleteContents(); 
    
    if (node.classList.contains('inserted-item')) {
      if (!node.querySelector('table')) {
          node.querySelectorAll('[contenteditable="true"]').forEach(el => el.setAttribute('contenteditable', 'false'));
      }
      
      const wrapper = document.createElement('span');
      wrapper.style.position = 'relative';
      wrapper.style.display = 'inline-block';
      wrapper.style.width = node.style.width;
      wrapper.style.height = node.style.height;
      node.style.top = '0px';
      node.style.left = '0px';
      wrapper.appendChild(node);
      
      range.insertNode(wrapper);

      const spaceNode = document.createTextNode('\u200B'); 
      if (wrapper.nextSibling) wrapper.parentNode.insertBefore(spaceNode, wrapper.nextSibling); 
      else wrapper.parentNode.appendChild(spaceNode); 
      
      const newRange = document.createRange(); 
      newRange.setStartAfter(spaceNode); 
      newRange.collapse(true); 
      sel.removeAllRanges(); 
      sel.addRange(newRange); 
    } else {
      range.insertNode(node);
      range.setStartAfter(node);
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
    }
}
function handleImageUpload(event, selector, isLogo) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = e => { const dataUrl = e.target.result; if (isLogo) { const logoContainer = workspace.querySelector('.logo-container'); logoContainer.innerHTML = `<img src="${dataUrl}" alt="logo">`; } else { const imgWrapper = document.createElement('div'); imgWrapper.className = 'inserted-item'; imgWrapper.style.width = '150px'; imgWrapper.style.height = 'auto'; imgWrapper.innerHTML = `<img src="${dataUrl}" />`; insertNodeAtCaret(imgWrapper); } }; reader.readAsDataURL(file); event.target.value = ''; }
function createMathTemplate(innerHTML) { const wrapper = document.createElement('span'); wrapper.style.display = 'inline-block'; wrapper.style.verticalAlign = 'middle'; wrapper.className = 'math-template'; wrapper.innerHTML = innerHTML; return wrapper; }
function insertFraction() { insertNodeAtCaret(createMathTemplate(`<span style="display:inline-block; text-align:center; vertical-align:middle;"><div contenteditable="true" style="min-width:20px; border-bottom:1.5px solid currentColor; padding:0 4px;">&nbsp;</div><div contenteditable="true" style="min-width:20px; padding:0 4px;">&nbsp;</div></span>`)); }
function insertSqrt() { const sqrtHTML = `<span style="display: inline-flex; vertical-align: middle;">`+ `<span style="font-size: 1.6em; line-height: 1; margin-top: 0.3em;">&radic;</span>`+ `<span contenteditable="true" style="display: block; border-top: 2px solid currentColor; padding: 0 5px; min-width: 40px; margin-left: -0.1em;">&nbsp;</span>`+ `</span>`; insertNodeAtCaret(createMathTemplate(sqrtHTML)); }
function insertPowerTemplate() { insertNodeAtCaret(createMathTemplate(`<span contenteditable="true" style="display:inline-block;"></span><sup contenteditable="true"></sup>`)); }
function insertMathTemplate(html) { insertNodeAtCaret(createMathTemplate(html)); }

// --- WORKSPACE INTERACTIONS ---
function handleWorkspaceClick(e) { 
    if (e.target.closest('.logo-container')) { document.getElementById('logo-input').click(); return; } 
    if (e.target.classList.contains('page-delete-btn')) { if(workspace.querySelectorAll('.page').length > 1) { e.target.closest('.page').remove(); updatePaginationUI(); } else { showModal('خطأ', 'لا يمكن حذف الصفحة الوحيدة.'); } return; } 
    if (e.target.classList.contains('row-delete-btn')) { e.target.closest('tr').remove(); return; } 
    if (e.target.classList.contains('row-save-template-btn')) { const questionCell = e.target.closest('tr').querySelector('.q-text'); if(questionCell) saveQuestionTemplate(questionCell.innerHTML); return; } 
    
    const clickedItem = e.target.closest('.inserted-item');
    if (clickedItem) {
        if(activeItem !== clickedItem) selectItem(clickedItem);
    } else if (activeItem && !e.target.closest('.item-controls') && !e.target.closest('#contextual-toolbar')) {
        deselectItem();
    }
}

// --- ITEM SELECTION & MANIPULATION (DRAG, RESIZE, ROTATE) ---
function selectItem(item) {
    if (activeItem) deselectItem();
    activeItem = item;
    item.classList.add('selected');

    const controls = document.createElement('div');
    controls.className = 'item-controls';
    controls.innerHTML = `<div class="resize-handle" title="تكبير/تصغير"></div><div class="rotate-handle" title="تدوير"></div><div class="delete-handle" title="حذف">&times;</div>`;
    item.appendChild(controls);

    // Attach listeners for drag/resize/rotate
    controls.querySelector('.resize-handle').addEventListener('mousedown', initAction);
    controls.querySelector('.rotate-handle').addEventListener('mousedown', initAction);
    controls.querySelector('.delete-handle').addEventListener('click', deleteActiveItem);
    item.addEventListener('mousedown', initAction);
    controls.querySelector('.resize-handle').addEventListener('touchstart', initAction, { passive: false });
    controls.querySelector('.rotate-handle').addEventListener('touchstart', initAction, { passive: false });
    item.addEventListener('touchstart', initAction, { passive: false });
    
    document.getElementById('rotate-item-btn').disabled = false;

    //  NEW CONTEXTUAL TOOLBAR LOGIC
    contextualToolbar.innerHTML = '';
    if (item.querySelector('table')) {
        populateTableControls(contextualToolbar);
    } else {
        populateShapeControls(contextualToolbar);
    }
    contextualToolbar.style.display = 'flex';
}

function deselectItem() {
    if (!activeItem) return;
    
    activeItem.classList.remove('selected');
    const controls = activeItem.querySelector('.item-controls');
    if (controls) controls.remove();

    // Remove event listeners to prevent memory leaks
    activeItem.removeEventListener('mousedown', initAction);
    activeItem.removeEventListener('touchstart', initAction);
    
    activeItem = null;
    document.getElementById('rotate-item-btn').disabled = true;

    // HIDE CONTEXTUAL TOOLBAR
    contextualToolbar.style.display = 'none';
}

function deleteActiveItem() { if (activeItem) { const itemToDelete = activeItem; deselectItem(); itemToDelete.parentElement.remove(); /* Remove the wrapper too */ } }
function rotateActiveItem() { if (!activeItem) return; const transform = window.getComputedStyle(activeItem).transform; let currentAngle = 0; if (transform && transform !== 'none') { const matrix = new DOMMatrixReadOnly(transform); currentAngle = Math.atan2(matrix.b, matrix.a) * (180 / Math.PI); } const newAngle = Math.round(currentAngle + 45); activeItem.style.transform = `rotate(${newAngle}deg)`; }
let initialPos, initialSize, actionType; function initAction(e) {
    if (e.target.closest('.inserted-item') && !e.target.classList.contains('resize-handle') && !e.target.classList.contains('rotate-handle')) {
        if (activeItem !== e.target.closest('.inserted-item')) selectItem(e.target.closest('.inserted-item'));
    }
    if (!activeItem) return;
    e.preventDefault();
    if (e.target.classList.contains('resize-handle')) actionType = 'resize';
    else if (e.target.classList.contains('rotate-handle')) actionType = 'rotate';
    else actionType = 'move';

    const rect = activeItem.getBoundingClientRect();
    const isTouchEvent = e.type.startsWith('touch');
    const clientX = isTouchEvent ? e.touches[0].clientX : e.clientX;
    const clientY = isTouchEvent ? e.touches[0].clientY : e.clientY;
    initialPos = { x: clientX, y: clientY, cx: rect.left + rect.width / 2, cy: rect.top + rect.height / 2, itemX: parseFloat(activeItem.style.left) || 0, itemY: parseFloat(activeItem.style.top) || 0 };
    const styles = window.getComputedStyle(activeItem);
    initialSize = { w: parseFloat(styles.width), h: parseFloat(styles.height) };
    const matrix = new DOMMatrixReadOnly(styles.transform === 'none' ? '' : styles.transform);
    const currentAngle = Math.atan2(matrix.b, matrix.a) * (180 / Math.PI);
    initialPos.startAngle = Math.atan2(initialPos.y - initialPos.cy, initialPos.x - initialPos.cx) * (180 / Math.PI) - currentAngle;
    window.addEventListener('mousemove', doAction);
    window.addEventListener('mouseup', stopAction);
    window.addEventListener('touchmove', doAction, { passive: false });
    window.addEventListener('touchend', stopAction);
}
function doAction(e) { if (!activeItem) return; const isTouchEvent = e.type.startsWith('touch'); if (isTouchEvent) e.preventDefault(); const clientX = isTouchEvent ? e.touches[0].clientX : e.clientX; const clientY = isTouchEvent ? e.touches[0].clientY : e.clientY;
    const dx = clientX - initialPos.x; const dy = clientY - initialPos.y;
    if (actionType === 'resize') { activeItem.style.width = Math.max(20, initialSize.w + dx) + 'px'; activeItem.style.height = Math.max(20, initialSize.h + dy) + 'px'; activeItem.parentElement.style.width = activeItem.style.width; activeItem.parentElement.style.height = activeItem.style.height; }
    else if (actionType === 'rotate') { const moveAngle = Math.atan2(clientY - initialPos.cy, clientX - initialPos.cx) * (180 / Math.PI); const rotation = moveAngle - initialPos.startAngle; activeItem.style.transform = `rotate(${rotation}deg)`; }
    else if (actionType === 'move') { moveActiveItem(dx, dy, true); initialPos.itemX += dx; initialPos.itemY += dy; initialPos.x = clientX; initialPos.y = clientY; }
}
function stopAction() { window.removeEventListener('mousemove', doAction); window.removeEventListener('mouseup', stopAction); window.removeEventListener('touchmove', doAction); window.removeEventListener('touchend', stopAction); }

// --- MODALS ---
function showModal(title, content, onConfirm) { modalContainer.innerHTML = ''; const modalBox = document.createElement('div'); modalBox.className = 'modal-box'; let modalHTML = `<h3>${title}</h3><div>${content}</div>`; const actions = onConfirm ? `<div class="modal-actions"><button id="modal-cancel-btn" class="btn">إلغاء</button><button id="modal-confirm-btn" class="btn">موافق</button></div>` : `<div class="modal-actions"><button id="modal-close-btn" class="btn">إغلاق</button></div>`; modalHTML += actions; modalBox.innerHTML = modalHTML; modalContainer.appendChild(modalBox); modalContainer.style.display = 'flex'; const closeModal = () => modalContainer.style.display = 'none'; if (onConfirm) { document.getElementById('modal-confirm-btn').onclick = () => { onConfirm(true); closeModal(); }; document.getElementById('modal-cancel-btn').onclick = () => { onConfirm(false); closeModal(); }; } else { document.getElementById('modal-close-btn').onclick = closeModal; } modalContainer.onclick = (e) => { if(e.target === modalContainer) closeModal(); }; }
function showBorderModal() { const content = `<p>اختر تصميم الإطار الذي سيتم تطبيقه على جميع الصفحات.</p><div class="border-options"><button class="btn" data-border-class=""><div class="border-preview"></div><span>عادي</span></button><button class="btn" data-border-class="border-double"><div class="border-preview border-double"></div><span>مزدوج</span></button><button class="btn" data-border-class="border-dotted"><div class="border-preview border-dotted"></div><span>منقط</span></button><button class="btn" data-border-class="border-dashed-thick"><div class="border-preview" style="border: 2px dashed var(--text-primary);"></div><span>متقطع عريض</span></button><button class="btn" data-border-class="border-double-color"><div class="border-preview" style="border: 4px double var(--accent);"></div><span>مزدوج ملون</span></button><button class="btn" data-border-class="border-gradient"><div class="border-preview" style="border: 4px solid; border-image: linear-gradient(45deg, var(--primary), var(--accent)) 1;"></div><span>متدرج</span></button><button class="btn" data-border-class="border-none"><div style="width:60px; height:40px; margin-bottom:5px; display:flex; align-items:center; justify-content:center; color: var(--text-muted);">(لا يوجد)</div><span>بدون</span></button></div>`; showModal('تخصيص إطار الصفحة', content); document.querySelectorAll('.border-options .btn').forEach(button => { button.addEventListener('click', () => { const borderClass = button.dataset.borderClass; workspace.querySelectorAll('.page').forEach(page => { page.classList.remove('border-double', 'border-dotted', 'border-none', 'border-dashed-thick', 'border-double-color', 'border-gradient'); if (borderClass) { page.classList.add(borderClass); } }); modalContainer.style.display = 'none'; }); }); }
function showTableModal() { const content = `<div class="form-group"><label for="table-rows">عدد الصفوف:</label><input type="number" id="table-rows" value="3" min="1"></div><div class="form-group"><label for="table-cols">عدد الأعمدة:</label><input type="number" id="table-cols" value="2" min="1"></div>`; showModal('إدراج جدول', content, (confirmed) => { if (confirmed) { const rows = document.getElementById('table-rows').value, cols = document.getElementById('table-cols').value; let tableHTML = '<table><tbody>'; for (let i = 0; i < rows; i++) { tableHTML += '<tr>'; for (let j = 0; j < cols; j++) { tableHTML += '<td contenteditable="true">&nbsp;</td>'; } tableHTML += '</tr>'; } tableHTML += '</tbody></table>'; const tableWrapper = document.createElement('div'); tableWrapper.className = 'inserted-item'; tableWrapper.style.width = '250px'; tableWrapper.style.height = 'auto'; tableWrapper.innerHTML = tableHTML; insertNodeAtCaret(tableWrapper); } }); }

// --- CONTEXTUAL TOOLBARS AND CONTROLS ---
function populateTableControls(toolbar) {
    toolbar.innerHTML = `
        <div class="controls-row">
            <span style="font-weight: bold; margin-inline-end: 10px;">أدوات الجدول:</span>
            <button id="ctx-tbl-add-row-above" class="btn" title="إضافة صف للأعلى">➕ صف ↑</button>
            <button id="ctx-tbl-add-row-below" class="btn" title="إضافة صف للأسفل">➕ صف ↓</button>
            <button id="ctx-tbl-add-col-left" class="btn" title="إضافة عمود لليسار">➕ عمود ←</button>
            <button id="ctx-tbl-add-col-right" class="btn" title="إضافة عمود لليمين">➕ عمود →</button>
        </div>
        <div class="controls-row">
            <button id="ctx-tbl-del-row" class="btn" title="حذف الصف">🗑️ صف</button>
            <button id="ctx-tbl-del-col" class="btn" title="حذف العمود">🗑️ عمود</button>
            <button id="ctx-tbl-merge-cells" class="btn" title="دمج الخلايا">دمج</button>
            <button id="ctx-tbl-split-cells" class="btn" title="تقسيم الخلية">تقسيم</button>
        </div>`;
    document.getElementById('ctx-tbl-add-row-above').addEventListener('click', () => modifyTable('addRow', 'above'));
    document.getElementById('ctx-tbl-add-row-below').addEventListener('click', () => modifyTable('addRow', 'below'));
    document.getElementById('ctx-tbl-add-col-left').addEventListener('click', () => modifyTable('addCol', 'left'));
    document.getElementById('ctx-tbl-add-col-right').addEventListener('click', () => modifyTable('addCol', 'right'));
    document.getElementById('ctx-tbl-del-row').addEventListener('click', () => modifyTable('deleteRow'));
    document.getElementById('ctx-tbl-del-col').addEventListener('click', () => modifyTable('deleteCol'));
    document.getElementById('ctx-tbl-merge-cells').addEventListener('click', () => modifyTable('merge'));
    document.getElementById('ctx-tbl-split-cells').addEventListener('click', () => modifyTable('split'));
}

function populateShapeControls(toolbar) {
    toolbar.innerHTML = `
        <div class="controls-row">
            <span style="font-weight: bold; margin-inline-end: 10px;">تحريك:</span>
            <button id="ctx-move-up" class="btn" title="تحريك للأعلى">↑</button>
            <button id="ctx-move-down" class="btn" title="تحريك للأسفل">↓</button>
            <button id="ctx-move-left" class="btn" title="تحريك لليسار">←</button>
            <button id="ctx-move-right" class="btn" title="تحريك لليمين">→</button>
        </div>
        <div class="controls-row">
            <span style="font-weight: bold; margin-inline-end: 10px;">عرض:</span>
            <input type="range" id="ctx-size-slider" min="20" max="500" value="120" style="width: 150px; direction: ltr;">
            <label id="ctx-size-label" style="min-width: 50px; text-align: right;">120px</label>
        </div>`;
    const moveAmount = 5;
    document.getElementById('ctx-move-up').addEventListener('click', () => moveActiveItem(0, -moveAmount));
    document.getElementById('ctx-move-down').addEventListener('click', () => moveActiveItem(0, moveAmount));
    document.getElementById('ctx-move-left').addEventListener('click', () => moveActiveItem(-moveAmount, 0));
    document.getElementById('ctx-move-right').addEventListener('click', () => moveActiveItem(moveAmount, 0));
    const sizeSlider = document.getElementById('ctx-size-slider');
    const sizeLabel = document.getElementById('ctx-size-label');
    if (activeItem) { const currentWidth = parseFloat(activeItem.style.width) || 120; sizeSlider.value = currentWidth; sizeLabel.textContent = `${Math.round(currentWidth)}px`; }
    sizeSlider.addEventListener('input', () => {
        if (!activeItem) return;
        const newWidth = sizeSlider.value;
        activeItem.style.width = newWidth + 'px';
        if (activeItem.parentElement.style.position === 'relative') { activeItem.parentElement.style.width = newWidth + 'px'; }
        sizeLabel.textContent = `${Math.round(newWidth)}px`;
    });
}

function moveActiveItem(dx, dy, isDrag = false) {
    if (!activeItem) return;
    let currentLeft = parseFloat(activeItem.style.left) || 0;
    let currentTop = parseFloat(activeItem.style.top) || 0;
    activeItem.style.left = (currentLeft + dx) + 'px';
    activeItem.style.top = (currentTop + dy) + 'px';
}

function modifyTable(action, option) {
    const tableInActiveItem = activeItem?.querySelector('table');
    if (!tableInActiveItem) {
        showModal('خطأ', 'الرجاء تحديد جدول مدرج أولاً.');
        return;
    }
    
    let currentCell = focusedEditable?.closest('td, th');
    if (!currentCell || !tableInActiveItem.contains(currentCell)) {
        currentCell = tableInActiveItem.querySelector('td, th');
    }

    if (!currentCell) {
        showModal('خطأ', 'لم يتم العثور على خلية للعمل عليها في الجدول المحدد.');
        return;
    }
    
    const row = currentCell.closest('tr');
    const table = currentCell.closest('table');
    if (!row || table !== tableInActiveItem) return;

    const rowIndex = row.rowIndex;
    const colIndex = currentCell.cellIndex;

    switch (action) {
        case 'addRow': const newRow = table.insertRow(option === 'above' ? rowIndex : rowIndex + 1); for (let i = 0; i < row.cells.length; i++) { const newCell = newRow.insertCell(i); newCell.contentEditable = true; newCell.innerHTML = '&nbsp;'; } break;
        case 'addCol': for (let i = 0; i < table.rows.length; i++) { const newCell = table.rows[i].insertCell(option === 'left' ? colIndex : colIndex + 1); newCell.contentEditable = true; newCell.innerHTML = '&nbsp;'; } break;
        case 'deleteRow': if (table.rows.length > 1) table.deleteRow(rowIndex); break;
        case 'deleteCol': if (row.cells.length > 1) { for (let i = 0; i < table.rows.length; i++) { table.rows[i].deleteCell(colIndex); } } break;
        case 'merge': document.execCommand('mergeCells'); break;
        case 'split': document.execCommand('splitCell'); break;
    }
}


// --- SHAPES, SYMBOLS, MATH EQUATIONS ---
const shapes = {
    rectangle: { name: 'مستطيل', svg: '<svg viewBox="0 0 100 60"><rect x="0" y="0" width="100" height="60" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    circle: { name: 'دائرة', svg: '<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    triangle: { name: 'مثلث', svg: '<svg viewBox="0 0 100 86.6"><polygon points="50,0 100,86.6 0,86.6" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    line: { name: 'خط', svg: '<svg viewBox="0 0 100 10"><line x1="0" y1="5" x2="100" y2="5" stroke="currentColor" stroke-width="2"/></svg>' },
    right_arrow: { name: 'سهم', svg: '<svg viewBox="0 0 100 30"><polygon points="0,10 70,10 70,0 100,15 70,30 70,20 0,20" fill="currentColor"/></svg>' },
    ellipse: { name: 'قطع ناقص', svg: '<svg viewBox="0 0 100 50"><ellipse cx="50" cy="25" rx="48" ry="23" fill="none" stroke="currentColor" stroke-width="2" /></svg>' },
    star: { name: 'نجمة', svg: '<svg viewBox="0 0 100 100"><polygon points="50,5 61,40 98,40 68,62 79,96 50,75 21,96 32,62 2,40 39,40" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    hexagon: { name: 'سداسي', svg: '<svg viewBox="0 0 100 86.6"><polygon points="25,0 75,0 100,43.3 75,86.6 25,86.6 0,43.3" fill="none" stroke="currentColor" stroke-width="2"/></svg>' }
};

const physicsShapes = {
    resistor: { name: 'مقاومة (R)', svg: '<svg viewBox="0 0 100 30"><path d="M0 15 L10 15 L15 5 L25 25 L35 5 L45 25 L55 5 L65 25 L75 5 L85 25 L90 15 L100 15" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    capacitor: { name: 'مكثف (C)', svg: '<svg viewBox="0 0 100 40"><path d="M0 20 L40 20 M60 20 L100 20 M40 5 L40 35 M60 5 L60 35" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    inductor: { name: 'ملف حث (L)', svg: '<svg viewBox="0 0 100 30"><path d="M0 15 L10 15 C 10 5, 20 5, 20 15 S 30 25, 40 15 S 50 5, 60 15 S 70 25, 80 15 L90 15 L100 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>' },
    battery_single: { name: 'بطارية (V)', svg: '<svg viewBox="0 0 100 40"><path d="M0 20 L35 20 M65 20 L100 20 M35 5 L35 35 M50 12 L50 28" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    ac_source: { name: 'مصدر متردد', svg: '<svg viewBox="0 0 100 40"><path d="M0 20 L30 20 M70 20 L100 20" stroke="currentColor" stroke-width="2"/><circle cx="50" cy="20" r="20" fill="none" stroke="currentColor" stroke-width="2"/><path d="M40 20 C 45 10, 55 30, 60 20" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    ground: { name: 'أرضي', svg: '<svg viewBox="0 0 40 40"><path d="M20 0 L20 20 M5 20 L35 20 M10 27 L30 27 M15 34 L25 34" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    voltmeter: { name: 'فولتميتر', svg: '<svg viewBox="0 0 100 50"><circle cx="50" cy="25" r="24" fill="none" stroke="currentColor" stroke-width="2"/><text x="50" y="32" font-size="24" text-anchor="middle" fill="currentColor" font-weight="bold">V</text></svg>' },
    ammeter: { name: 'أميتر', svg: '<svg viewBox="0 0 100 50"><circle cx="50" cy="25" r="24" fill="none" stroke="currentColor" stroke-width="2"/><text x="50" y="32" font-size="24" text-anchor="middle" fill="currentColor" font-weight="bold">A</text></svg>' },
    impedance: { name: 'معاوقة (Z)', svg: '<svg viewBox="0 0 100 30" fill="none" stroke="currentColor" stroke-width="2"><path d="M0 15 L20 15 L80 15 L100 15"/><rect x="20" y="5" width="60" height="20"/></svg>'},
    lens_convex: { name: 'عدسة محدبة', svg: '<svg viewBox="0 0 50 100"><path d="M25 0 C 50 25, 50 75, 25 100 C 0 75, 0 25, 25 0 Z" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    lens_concave: { name: 'عدسة مقعرة', svg: '<svg viewBox="0 0 50 100"><path d="M0 0 C 25 25, 25 75, 0 100 M50 0 C 25 25, 25 75, 50 100" fill="none" stroke="currentColor" stroke-width="2"/></svg>' },
    prism: { name: 'منشور', svg: '<svg viewBox="0 0 100 87"><polygon points="50,0 100,86.6 0,86.6" fill="none" stroke="currentColor" stroke-width="2"/></svg>'},
};

function showShapeModal() { 
    let shapeGridHTML = '<div><h4>أشكال أساسية</h4><div class="shape-grid">'; 
    for (const [key, shape] of Object.entries(shapes)) { shapeGridHTML += `<div class="shape-item" data-shape-svg='${escapeHtml(shape.svg)}'>${shape.svg}<small>${shape.name}</small></div>`; } 
    shapeGridHTML += '</div>';

    shapeGridHTML += '<h4 style="margin-top: 15px;">مكونات إلكترونية وبصريات</h4><div class="shape-grid">';
    for (const [key, shape] of Object.entries(physicsShapes)) { shapeGridHTML += `<div class="shape-item" data-shape-svg='${escapeHtml(shape.svg)}'>${shape.svg}<small>${shape.name}</small></div>`; }
    shapeGridHTML += '</div></div>';

    showModal('اختر شكلاً', shapeGridHTML); 
    document.querySelectorAll('.shape-item').forEach(item => { item.onclick = () => { insertShape(item.dataset.shapeSvg); modalContainer.style.display = 'none'; }; }); 
} 
function insertShape(svgCode) { const shapeWrapper = document.createElement('div'); shapeWrapper.className = 'inserted-item'; shapeWrapper.style.width = '120px'; shapeWrapper.style.height = '120px'; shapeWrapper.innerHTML = svgCode; insertNodeAtCaret(shapeWrapper); }

const mathEquations = { 
    quadratic: { name: 'القانون العام', html: `<span dir="rtl" style="font-family: var(--font-formal); font-size: 1.2em;">س = <span style="display:inline-block; text-align:center; vertical-align:middle;"><div style="min-width:120px; border-bottom:1.5px solid currentColor; padding:0 4px;">&minus;ب &plusmn; &radic;<span style="border-top:1.5px solid currentColor; padding: 0 3px;">ب&sup٢; &minus; ٤ أ ج</span></div><div style="min-width:30px; padding:0 4px;">٢ أ</div></span></span>` }, 
    pythagorean: { name: 'نظرية فيثاغورس', html: `<span dir="ltr" style="font-family: var(--font-formal); font-size: 1.2em;">a&sup2; + b&sup2; = c&sup2;</span>`},
    circle_area: { name: 'مساحة الدائرة', html: `<span dir="rtl" style="font-family: var(--font-formal); font-size: 1.2em;">م = ط نق&sup٢;</span>`},
    diff_squares: { name: 'فرق مربعين', html: `<span dir="ltr" style="font-family: var(--font-formal); font-size: 1.2em;">x&sup2; &minus; y&sup2; = (x &minus; y)(x + y)</span>`}, 
    indic_fraction: { name: 'كسر بالأرقام الهندية', html: `<span style="display:inline-block; text-align:center; vertical-align:middle; font-family: 'Noto Naskh Arabic'; font-size: 1.2em;"><div contenteditable="true" style="min-width:30px; border-bottom:1.5px solid currentColor; padding:0 4px;">٣</div><div contenteditable="true" style="min-width:30px; padding:0 4px;">٤</div></span>`},
    algebra_expr: { name: 'مقدار جبري', html: `<span style="font-family: var(--font-formal); font-size: 1.2em;" dir="rtl">(س + ص)&sup٢; = س&sup٢; + ٢س ص + ص&sup٢;</span>`},
    velocity: { name: 'السرعة (فيزياء)', html: `ع = <span style="display:inline-block; text-align:center; vertical-align:middle;"><div contenteditable="true" style="border-bottom:1.5px solid currentColor; padding:0 4px;">ف</div><div contenteditable="true" style="padding:0 4px;">ز</div></span>`}, 
    force: { name: 'القوة (فيزياء)', html: `<span dir="rtl">ق = ك &times; ت</span>`}, 
    density: { name: 'الكثافة (فيزياء)', html: `ث = <span style="display:inline-block; text-align:center; vertical-align:middle;"><div contenteditable="true" style="border-bottom:1.5px solid currentColor; padding:0 4px;">ك</div><div contenteditable="true" style="padding:0 4px;">ح</div></span>`}, 
    ohms_law: { name: 'قانون أوم (فيزياء)', html: `<span dir="rtl">ج = ت &times; م</span>`}, 
    gas_law: { name: 'الغازات المثالية (كيمياء)', html: `<span dir="ltr" style="font-family: var(--font-formal); font-size: 1.2em;">PV = nRT</span>`}, 
    molarity: { name: 'المولارية (كيمياء)', html: `التركيز (م) = <span style="display:inline-block; text-align:center; vertical-align:middle;"><div contenteditable="true" style="border-bottom:1.5px solid currentColor; padding:0 4px;">عدد مولات المذاب</div><div contenteditable="true" style="padding:0 4px;">حجم المحلول (لتر)</div></span>`}};
function showMathEquationsModal() { let mathGridHTML = '<div class="math-grid">'; for (const [key, eq] of Object.entries(mathEquations)) { mathGridHTML += `<div class="math-item" data-math-html='${escapeHtml(eq.html)}'>${eq.html}<small>${eq.name}</small></div>`; } mathGridHTML += '</div>'; showModal('اختر معادلة', mathGridHTML); document.querySelectorAll('.math-item').forEach(item => { item.onclick = () => { insertMathTemplate(item.dataset.mathHtml); modalContainer.style.display = 'none'; }; }); }

const commonSymbols = ['≠', '≤', '≥', '≈', '∞', '±', '°', '∠', '‰', '§', '¶', '©', '®', '™', '·', '…', '∴', '∵'];
const physicsSymbols = ['α', 'β', 'γ', 'δ', 'ε', 'θ', 'λ', 'μ', 'π', 'ρ', 'σ', 'τ', 'ω', 'Φ', 'Ω', '∇', 'ħ', '∆', '∫', '∮', '∂'];
const arrowSymbols = ['←', '↑', '→', '↓', '↔', '↕', '↖', '↗', '↘', '↙', '↚', '↛', '↮', '⇦', '⇧', '⇨', '⇩', '⬄', '⇌', '⇔', '⇒', '⇐', '↦', '⟷', '➽'];

function showSymbolModal() { 
    let symbolHTML = '<div>';
    
    symbolHTML += '<h4>رموز شائعة</h4><div class="symbol-grid">';
    commonSymbols.forEach(symbol => { symbolHTML += `<div class="symbol-item" data-symbol="${symbol}">${symbol}</div>`; });
    symbolHTML += '</div>';

    symbolHTML += '<h4 style="margin-top: 15px;">رموز فيزيائية</h4><div class="symbol-grid">';
    physicsSymbols.forEach(symbol => { symbolHTML += `<div class="symbol-item" data-symbol="${symbol}">${symbol}</div>`; });
    symbolHTML += '</div>';

    symbolHTML += '<h4 style="margin-top: 15px;">أسهم</h4><div class="symbol-grid">';
    arrowSymbols.forEach(symbol => { symbolHTML += `<div class="symbol-item" data-symbol="${symbol}">${symbol}</div>`; });
    symbolHTML += '</div></div>';

    showModal('إدراج رمز', symbolHTML); 
    document.querySelectorAll('.symbol-item').forEach(item => { item.onclick = () => { const symbol = item.dataset.symbol; const symbolNode = document.createElement('span'); symbolNode.textContent = symbol; insertNodeAtCaret(symbolNode); modalContainer.style.display = 'none'; }; }); 
}

// --- QUESTION TEMPLATES ---
const questionTemplates = { true_false: { name: 'ضع علامة (✓) أو (×)', html: `<p>ضع علامة (✓) أمام العبارة الصحيحة وعلامة (×) أمام العبارة الخاطئة:</p><p>( &nbsp; &nbsp; &nbsp;) <span contenteditable="true">اكتب العبارة هنا...</span></p>`}, match: { name: 'صل بين العمودين', html: `<p>صل العبارات في العمود (أ) بما يناسبها في العمود (ب):</p><table style="width:100%; border-collapse: collapse;" border="1"><thead><tr style="text-align:center; font-weight:bold;"><td>العمود (أ)</td><td>العمود (ب)</td></tr></thead><tbody><tr><td contenteditable="true">&nbsp;</td><td contenteditable="true">&nbsp;</td></tr><tr><td contenteditable="true">&nbsp;</td><td contenteditable="true">&nbsp;</td></tr><tr><td contenteditable="true">&nbsp;</td><td contenteditable="true">&nbsp;</td></tr></tbody></table>`}, mcq: { name: 'اختر الإجابة الصحيحة', html: `<p contenteditable="true">اختر الإجابة الصحيحة من بين الأقواس:</p><p contenteditable="true">أ) ... &nbsp;&nbsp;&nbsp; ب) ... &nbsp;&nbsp;&nbsp; ج) ... &nbsp;&nbsp;&nbsp; د) ...</p>`},};
function showQuestionTemplateModal() { let templateGridHTML = '<div class="template-list">'; for(const [key, template] of Object.entries(questionTemplates)) { templateGridHTML += `<div class="template-item" data-template-key="${key}"><span>${template.name}</span></div>`; } templateGridHTML += `<hr><h4 style="text-align:center; margin-top:10px;">قوالبي المحفوظة</h4>`; const savedTemplates = getSavedQuestionTemplates(); savedTemplates.forEach((template, index) => { templateGridHTML += `<div class="template-item" data-saved-template-index="${index}"><span class="template-content">${escapeHtml(template.replace(/<[^>]+>/g, '').substring(0, 50))}...</span><button onclick="deleteSavedTemplate(event, ${index})">&times;</button></div>`; }); templateGridHTML += '</div>'; showModal('إدراج قالب سؤال', templateGridHTML); document.querySelectorAll('.template-item[data-template-key]').forEach(item => { item.onclick = () => { addQuestionToTable(questionTemplates[item.dataset.templateKey].html); modalContainer.style.display = 'none'; }; }); document.querySelectorAll('.template-item[data-saved-template-index]').forEach(item => { item.onclick = () => { const index = parseInt(item.dataset.savedTemplateIndex); const savedTemplates = getSavedQuestionTemplates(); addQuestionToTable(savedTemplates[index]); modalContainer.style.display = 'none'; }; }); }
function saveQuestionTemplate(htmlContent) { let templates = getSavedQuestionTemplates(); templates.push(htmlContent); localStorage.setItem('questionTemplates', JSON.stringify(templates)); showModal('تم الحفظ', 'تم حفظ قالب السؤال بنجاح.'); }
function getSavedQuestionTemplates() { return JSON.parse(localStorage.getItem('questionTemplates') || '[]'); }
function deleteSavedTemplate(event, index) { event.stopPropagation(); let templates = getSavedQuestionTemplates(); templates.splice(index, 1); localStorage.setItem('questionTemplates', JSON.stringify(templates)); modalContainer.style.display = 'none'; showQuestionTemplateModal(); }

// --- UTILITY ---
function escapeHtml(s) { if(!s) return ''; return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#x27;'}[c])); }
</script>
</body>
</html>
